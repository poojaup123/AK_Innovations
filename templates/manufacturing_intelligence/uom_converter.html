{% extends "base.html" %}

{% block title %}Smart UOM Converter{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-exchange-alt"></i> Smart UOM Converter</h2>
                <a href="{{ url_for('manufacturing_intelligence.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
            <p class="text-muted">Intelligent unit conversion for manufacturing workflow</p>
        </div>
    </div>

    <div class="row">
        <!-- Conversion Calculator -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calculator"></i> Unit Conversion Calculator</h5>
                </div>
                <div class="card-body">
                    <form id="conversionForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="quantity" step="0.001" placeholder="Enter quantity">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">From Unit</label>
                                <select class="form-select" id="fromUnit">
                                    <option value="">Select unit</option>
                                    <optgroup label="Weight">
                                        <option value="kg">Kilograms (kg)</option>
                                        <option value="g">Grams (g)</option>
                                        <option value="ton">Tons</option>
                                        <option value="lbs">Pounds (lbs)</option>
                                        <option value="oz">Ounces (oz)</option>
                                    </optgroup>
                                    <optgroup label="Length">
                                        <option value="m">Meters (m)</option>
                                        <option value="cm">Centimeters (cm)</option>
                                        <option value="mm">Millimeters (mm)</option>
                                        <option value="ft">Feet (ft)</option>
                                        <option value="in">Inches (in)</option>
                                    </optgroup>
                                    <optgroup label="Volume">
                                        <option value="l">Liters (l)</option>
                                        <option value="ml">Milliliters (ml)</option>
                                        <option value="gal">Gallons (gal)</option>
                                    </optgroup>
                                    <optgroup label="Count">
                                        <option value="pcs">Pieces (pcs)</option>
                                        <option value="nos">Numbers (nos)</option>
                                        <option value="dozen">Dozen</option>
                                        <option value="gross">Gross</option>
                                    </optgroup>
                                    <optgroup label="Area">
                                        <option value="sqm">Square Meters (sqm)</option>
                                        <option value="sqft">Square Feet (sqft)</option>
                                        <option value="sqcm">Square Centimeters (sqcm)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">To Unit</label>
                                <select class="form-select" id="toUnit">
                                    <option value="">Select unit</option>
                                    <optgroup label="Weight">
                                        <option value="kg">Kilograms (kg)</option>
                                        <option value="g">Grams (g)</option>
                                        <option value="ton">Tons</option>
                                        <option value="lbs">Pounds (lbs)</option>
                                        <option value="oz">Ounces (oz)</option>
                                    </optgroup>
                                    <optgroup label="Length">
                                        <option value="m">Meters (m)</option>
                                        <option value="cm">Centimeters (cm)</option>
                                        <option value="mm">Millimeters (mm)</option>
                                        <option value="ft">Feet (ft)</option>
                                        <option value="in">Inches (in)</option>
                                    </optgroup>
                                    <optgroup label="Volume">
                                        <option value="l">Liters (l)</option>
                                        <option value="ml">Milliliters (ml)</option>
                                        <option value="gal">Gallons (gal)</option>
                                    </optgroup>
                                    <optgroup label="Count">
                                        <option value="pcs">Pieces (pcs)</option>
                                        <option value="nos">Numbers (nos)</option>
                                        <option value="dozen">Dozen</option>
                                        <option value="gross">Gross</option>
                                    </optgroup>
                                    <optgroup label="Area">
                                        <option value="sqm">Square Meters (sqm)</option>
                                        <option value="sqft">Square Feet (sqft)</option>
                                        <option value="sqcm">Square Centimeters (sqcm)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Custom Factor</label>
                                <input type="number" class="form-control" id="customFactor" step="0.001" placeholder="Optional">
                                <small class="text-muted">Override standard conversion</small>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" onclick="convertUnits()">
                                    <i class="fas fa-exchange-alt"></i> Convert
                                </button>
                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearForm()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Conversion Result -->
                    <div id="conversionResult" class="mt-4" style="display: none;">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Conversion Result</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Original:</strong> <span id="originalValue"></span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Converted:</strong> <span id="convertedValue"></span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Conversion Rate:</strong> <span id="conversionRate"></span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="conversionError" class="mt-4" style="display: none;">
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> Conversion Error</h5>
                            <p id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Quick Reference</h5>
                </div>
                <div class="card-body">
                    <h6>Common Manufacturing Conversions:</h6>
                    <ul class="list-unstyled">
                        <li><strong>Weight:</strong></li>
                        <li class="ms-3">1 kg = 1,000 g</li>
                        <li class="ms-3">1 ton = 1,000 kg</li>
                        <li class="ms-3">1 lbs = 0.454 kg</li>
                        
                        <li class="mt-2"><strong>Length:</strong></li>
                        <li class="ms-3">1 m = 100 cm = 1,000 mm</li>
                        <li class="ms-3">1 ft = 12 in = 30.48 cm</li>
                        
                        <li class="mt-2"><strong>Count:</strong></li>
                        <li class="ms-3">1 dozen = 12 pcs</li>
                        <li class="ms-3">1 gross = 144 pcs</li>
                        
                        <li class="mt-2"><strong>Volume:</strong></li>
                        <li class="ms-3">1 l = 1,000 ml</li>
                        <li class="ms-3">1 gal = 3.785 l</li>
                    </ul>

                    <hr>

                    <h6>Workflow Integration:</h6>
                    <p class="small text-muted">
                        This converter automatically integrates with:
                    </p>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success"></i> Purchase Orders</li>
                        <li><i class="fas fa-check text-success"></i> Job Work Creation</li>
                        <li><i class="fas fa-check text-success"></i> GRN Processing</li>
                        <li><i class="fas fa-check text-success"></i> Inventory Management</li>
                    </ul>
                </div>
            </div>

            <!-- Recent Conversions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Recent Conversions</h5>
                </div>
                <div class="card-body">
                    <div id="recentConversions">
                        <p class="text-muted text-center">No recent conversions</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let conversionHistory = JSON.parse(localStorage.getItem('uomConversions') || '[]');

function convertUnits() {
    const quantity = parseFloat(document.getElementById('quantity').value);
    const fromUnit = document.getElementById('fromUnit').value;
    const toUnit = document.getElementById('toUnit').value;
    const customFactor = document.getElementById('customFactor').value;
    
    // Hide previous results
    document.getElementById('conversionResult').style.display = 'none';
    document.getElementById('conversionError').style.display = 'none';
    
    // Validation
    if (!quantity || !fromUnit || !toUnit) {
        showError('Please fill in all required fields');
        return;
    }
    
    if (quantity <= 0) {
        showError('Quantity must be greater than 0');
        return;
    }
    
    // Prepare conversion data
    const conversionData = {
        quantity: quantity,
        from_uom: fromUnit,
        to_uom: toUnit
    };
    
    if (customFactor) {
        conversionData.conversion_factor = parseFloat(customFactor);
    }
    
    // Make API call
    fetch('/manufacturing-intelligence/api/convert-uom', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(conversionData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(data);
            addToHistory(data);
        } else {
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Conversion failed. Please try again.');
    });
}

function showResult(data) {
    document.getElementById('originalValue').textContent = 
        `${data.original_quantity} ${data.original_uom}`;
    document.getElementById('convertedValue').textContent = 
        `${data.converted_quantity.toFixed(3)} ${data.converted_uom}`;
    document.getElementById('conversionRate').textContent = 
        `1 ${data.original_uom} = ${(data.converted_quantity / data.original_quantity).toFixed(6)} ${data.converted_uom}`;
    
    document.getElementById('conversionResult').style.display = 'block';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('conversionError').style.display = 'block';
}

function clearForm() {
    document.getElementById('quantity').value = '';
    document.getElementById('fromUnit').value = '';
    document.getElementById('toUnit').value = '';
    document.getElementById('customFactor').value = '';
    document.getElementById('conversionResult').style.display = 'none';
    document.getElementById('conversionError').style.display = 'none';
}

function addToHistory(data) {
    const historyItem = {
        timestamp: new Date().toLocaleString(),
        original: `${data.original_quantity} ${data.original_uom}`,
        converted: `${data.converted_quantity.toFixed(3)} ${data.converted_uom}`,
        rate: (data.converted_quantity / data.original_quantity).toFixed(6)
    };
    
    conversionHistory.unshift(historyItem);
    conversionHistory = conversionHistory.slice(0, 5); // Keep only 5 recent
    
    localStorage.setItem('uomConversions', JSON.stringify(conversionHistory));
    updateHistoryDisplay();
}

function updateHistoryDisplay() {
    const container = document.getElementById('recentConversions');
    
    if (conversionHistory.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No recent conversions</p>';
        return;
    }
    
    let html = '';
    conversionHistory.forEach(item => {
        html += `
            <div class="small mb-2 p-2 bg-light rounded">
                <div><strong>${item.original}</strong> → <strong>${item.converted}</strong></div>
                <div class="text-muted">${item.timestamp}</div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Initialize history display
document.addEventListener('DOMContentLoaded', function() {
    updateHistoryDisplay();
});
</script>
{% endblock %}