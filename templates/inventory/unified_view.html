{% extends "base.html" %}

{% block title %}Unified Inventory View - Factory Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-boxes me-2"></i>Unified Inventory Management</h2>
                <div>
                    <a href="{{ url_for('inventory.add_item') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </a>
                    <button class="btn btn-outline-secondary" onclick="toggleAdvancedColumns()">
                        <i class="fas fa-eye me-1"></i><span id="toggleText">Hide Advanced</span>
                    </button>
                    <a href="{{ url_for('inventory.export_items') }}" class="btn btn-success">
                        <i class="fas fa-file-excel me-1"></i>Export Excel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h5><i class="fas fa-info-circle me-2"></i>Unified Inventory Overview</h5>
                <div class="row">
                    <div class="col-md-2">
                        <strong class="text-primary">Raw Material:</strong> Ready for processing
                    </div>
                    <div class="col-md-2">
                        <strong class="text-warning">WIP:</strong> Sent for job work
                    </div>
                    <div class="col-md-2">
                        <strong class="text-success">Finished:</strong> Completed materials
                    </div>
                    <div class="col-md-2">
                        <strong class="text-danger">Scrap:</strong> Rejected/damaged
                    </div>
                    <div class="col-md-2">
                        <strong class="text-info">Total:</strong> Sum of all states
                    </div>
                    <div class="col-md-2">
                        <strong class="text-dark">Available:</strong> Ready for sale/use
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-search me-2"></i>Search & Filters</h6>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <input type="text" class="form-control" name="search" 
                                   value="{{ request.args.get('search', '') }}" 
                                   placeholder="Item name or code...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Item Type</label>
                            <select class="form-select" name="item_type">
                                <option value="">All Types</option>
                                {% for item_type in item_types %}
                                <option value="{{ item_type.name }}" 
                                        {{ 'selected' if request.args.get('item_type') == item_type.name }}>
                                    {{ item_type.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Stock Status</label>
                            <select class="form-select" name="stock_status">
                                <option value="">All Status</option>
                                <option value="low" {{ 'selected' if request.args.get('stock_status') == 'low' }}>Low Stock</option>
                                <option value="out" {{ 'selected' if request.args.get('stock_status') == 'out' }}>Out of Stock</option>
                                <option value="available" {{ 'selected' if request.args.get('stock_status') == 'available' }}>Available</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Min Price</label>
                            <input type="number" class="form-control" name="min_price" 
                                   value="{{ request.args.get('min_price', '') }}" 
                                   placeholder="0" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Max Price</label>
                            <input type="number" class="form-control" name="max_price" 
                                   value="{{ request.args.get('max_price', '') }}" 
                                   placeholder="999999" step="0.01">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">Filter</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Inventory Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>All Items <span class="badge bg-primary">{{ items|length }}</span></h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" style="font-size: 0.9em;">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="min-width: 90px;">Item Code</th>
                                    <th style="min-width: 120px;">Item Name</th>
                                    <th style="min-width: 80px;">Type</th>
                                    <th style="min-width: 60px;">UOM</th>
                                    <!-- Multi-State Columns -->
                                    <th style="min-width: 80px;" class="text-primary advanced-col">Raw Material</th>
                                    <th style="min-width: 80px;" class="text-warning advanced-col">WIP</th>
                                    <th style="min-width: 80px;" class="text-success advanced-col">Finished</th>
                                    <th style="min-width: 80px;" class="text-danger advanced-col">Scrap</th>
                                    <!-- Summary Columns -->
                                    <th style="min-width: 90px;" class="text-info">Total Stock</th>
                                    <th style="min-width: 90px;" class="text-dark">Available</th>
                                    <th style="min-width: 80px;">Min Stock</th>
                                    <th style="min-width: 90px;">Unit Price</th>
                                    <th style="min-width: 100px;">Stock Value</th>
                                    <!-- Additional Columns -->
                                    <th style="min-width: 80px;">Unit Weight</th>
                                    <th style="min-width: 80px;">HSN Code</th>
                                    <th style="min-width: 70px;">GST Rate</th>
                                    <th style="min-width: 90px;">Last Updated</th>
                                    <th style="min-width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                {% set is_low_stock = (item.available_stock or 0) <= (item.minimum_stock or 0) and (item.minimum_stock or 0) > 0 %}
                                {% set is_out_stock = (item.available_stock or 0) == 0 %}
                                <tr class="{{ 'table-danger' if is_out_stock else 'table-warning' if is_low_stock else '' }}">
                                    <td><strong style="font-size: 0.85em;">{{ item.code }}</strong></td>
                                    <td>
                                        <strong>{{ item.name }}</strong>
                                        {% if item.description %}
                                            <br><small class="text-muted">{{ item.description }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ item.display_item_type }}</span>
                                    </td>
                                    <td><small>{{ item.unit_of_measure }}</small></td>
                                    
                                    <!-- Multi-State Inventory Columns -->
                                    <td class="text-primary advanced-col">
                                        <strong>{{ "%.1f"|format(item.qty_raw or 0) }}</strong>
                                        {% if (item.qty_raw or 0) > 0 %}
                                            <i class="fas fa-circle text-primary" style="font-size: 0.5em;"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-warning advanced-col">
                                        <strong>{{ "%.1f"|format(item.total_wip or 0) }}</strong>
                                        {% if (item.total_wip or 0) > 0 %}
                                            <i class="fas fa-circle text-warning" style="font-size: 0.5em;"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-success advanced-col">
                                        <strong>{{ "%.1f"|format(item.qty_finished or 0) }}</strong>
                                        {% if (item.qty_finished or 0) > 0 %}
                                            <i class="fas fa-circle text-success" style="font-size: 0.5em;"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-danger advanced-col">
                                        <strong>{{ "%.1f"|format(item.qty_scrap or 0) }}</strong>
                                        {% if (item.qty_scrap or 0) > 0 %}
                                            <i class="fas fa-circle text-danger" style="font-size: 0.5em;"></i>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Summary Columns -->
                                    <td class="text-info">
                                        <strong>{{ "%.1f"|format(item.total_stock or 0) }}</strong>
                                    </td>
                                    <td class="text-dark">
                                        <strong>{{ "%.1f"|format(item.available_stock or 0) }}</strong>
                                        {% if is_out_stock %}
                                            <span class="badge bg-danger ms-1">Out</span>
                                        {% elif is_low_stock %}
                                            <span class="badge bg-warning ms-1">Low</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td>{{ item.minimum_stock or 0 }}</td>
                                    <td>₹{{ "%.2f"|format(item.unit_price or 0) }}</td>
                                    <td>
                                        {% set stock_value = (item.available_stock or 0) * (item.unit_price or 0) %}
                                        <strong>₹{{ "%.2f"|format(stock_value) }}</strong>
                                    </td>
                                    
                                    <!-- Additional Data Columns -->
                                    <td>
                                        {% if item.unit_weight and item.unit_weight > 0 %}
                                            {{ "%.3f"|format(item.unit_weight) }} kg
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.hsn_code %}
                                            <small>{{ item.hsn_code }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.gst_rate and item.gst_rate > 0 %}
                                            <span class="badge bg-info">{{ item.gst_rate }}%</span>
                                        {% else %}
                                            <span class="text-muted">0%</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.created_at %}
                                            <small>{{ item.created_at.strftime('%d/%m/%Y') }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('inventory.edit_item', id=item.id) }}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ url_for('inventory.edit_item', id=item.id) }}" 
                                               class="btn btn-outline-info btn-sm" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mt-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-primary">{{ "%.0f"|format(items|sum(attribute='qty_raw') or 0) }}</h5>
                    <small>Raw Material</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-warning">{{ "%.0f"|format(items|sum(attribute='total_wip') or 0) }}</h5>
                    <small>WIP</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-success">{{ "%.0f"|format(items|sum(attribute='qty_finished') or 0) }}</h5>
                    <small>Finished</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-danger">{{ "%.0f"|format(items|sum(attribute='qty_scrap') or 0) }}</h5>
                    <small>Scrap</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-info">{{ "%.0f"|format(items|sum(attribute='total_stock') or 0) }}</h5>
                    <small>Total Stock</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-dark">{{ "%.0f"|format(items|sum(attribute='available_stock') or 0) }}</h5>
                    <small>Available</small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAdvancedColumns() {
    const advancedCols = document.querySelectorAll('.advanced-col');
    const toggleText = document.getElementById('toggleText');
    const isVisible = advancedCols[0].style.display !== 'none';
    
    advancedCols.forEach(col => {
        col.style.display = isVisible ? 'none' : '';
    });
    
    toggleText.textContent = isVisible ? 'Show Advanced' : 'Hide Advanced';
}

// Auto-highlight low stock rows
document.addEventListener('DOMContentLoaded', function() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const availableCell = row.children[9]; // Available stock column
        const minStockCell = row.children[10]; // Min stock column
        
        if (availableCell && minStockCell) {
            const available = parseFloat(availableCell.textContent.trim());
            const minStock = parseFloat(minStockCell.textContent.trim());
            
            if (available === 0) {
                row.classList.add('table-danger');
            } else if (available <= minStock && minStock > 0) {
                row.classList.add('table-warning');
            }
        }
    });
});
</script>
{% endblock %}