{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-search me-2"></i>Daily Entry Inspection</h2>
                <div>
                    <a href="{{ url_for('material_inspection.dashboard') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Daily Entry Details -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Daily Work Entry Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Job Work Number:</strong></td>
                                    <td>{{ daily_entry.job_work.job_number }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Worker Name:</strong></td>
                                    <td>{{ daily_entry.worker_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Work Date:</strong></td>
                                    <td>{{ daily_entry.work_date.strftime('%d %B %Y') }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Hours Worked:</strong></td>
                                    <td>{{ daily_entry.hours_worked }} hours</td>
                                </tr>
                                <tr>
                                    <td><strong>Item:</strong></td>
                                    <td>{{ daily_entry.job_work.item.name }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Quantity Completed:</strong></td>
                                    <td>{{ daily_entry.quantity_completed }} {{ daily_entry.job_work.item.unit_of_measure }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Scrap Quantity:</strong></td>
                                    <td>{{ daily_entry.scrap_quantity or 0 }} {{ daily_entry.job_work.item.unit_of_measure }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Quality Status:</strong></td>
                                    <td>
                                        <span class="badge {{ daily_entry.quality_badge_class }}">
                                            {{ daily_entry.quality_status.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Process Stage:</strong></td>
                                    <td>
                                        <span class="badge {{ daily_entry.stage_badge_class }}">
                                            {{ daily_entry.process_stage.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Current Status:</strong></td>
                                    <td>
                                        <span class="badge {% if daily_entry.inspection_status == 'pending' %}bg-warning{% elif daily_entry.inspection_status == 'passed' %}bg-success{% else %}bg-danger{% endif %}">
                                            {{ daily_entry.inspection_status.title() }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    {% if daily_entry.notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6><i class="fas fa-sticky-note"></i> Worker Notes:</h6>
                            <div class="alert alert-light">{{ daily_entry.notes }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Inspection Action Panel -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check"></i> Inspection Actions</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Review the daily work entry and decide on inspection outcome:</p>
                    
                    <form id="inspectionForm">
                        <div class="mb-3">
                            <label for="material_classification" class="form-label">Material Classification</label>
                            <select class="form-select" id="material_classification" name="material_classification" required>
                                <option value="raw_material" {% if daily_entry.material_classification == 'raw_material' %}selected{% endif %}>Raw Material</option>
                                <option value="production_use" {% if daily_entry.material_classification == 'production_use' %}selected{% endif %}>Production Use</option>
                                <option value="finished_goods" {% if daily_entry.material_classification == 'finished_goods' %}selected{% endif %}>Finished Goods</option>
                            </select>
                            <div class="form-text">
                                <i class="fas fa-tag me-1"></i>
                                Categorize this material for tracking purposes
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="inspection_notes" class="form-label">Inspection Notes</label>
                            <textarea class="form-control" id="inspection_notes" name="inspection_notes" rows="4" 
                                      placeholder="Add any inspection observations, quality checks, or feedback..."></textarea>
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="approveEntry()">
                                <i class="fas fa-check"></i> Approve Entry
                            </button>
                            <button type="button" class="btn btn-danger" onclick="rejectEntry()">
                                <i class="fas fa-times"></i> Reject Entry
                            </button>
                        </div>
                    </form>
                    
                    <hr class="my-3">
                    
                    <div class="alert alert-info alert-sm">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> Approving this entry will validate the work quality and quantity for inventory updates.
                    </div>
                </div>
            </div>
            
            <!-- Job Work Context -->
            <div class="card mt-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Job Work Context</h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td><strong>Work Type:</strong></td>
                            <td>
                                <span class="badge {{ daily_entry.job_work.work_type_badge_class }}">
                                    {{ daily_entry.job_work.work_type_display }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Department:</strong></td>
                            <td>{{ daily_entry.job_work.department.replace('_', ' ').title() if daily_entry.job_work.department else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Sent:</strong></td>
                            <td>{{ daily_entry.job_work.quantity_sent }} {{ daily_entry.job_work.item.unit_of_measure }}</td>
                        </tr>
                        <tr>
                            <td><strong>Job Status:</strong></td>
                            <td>
                                <span class="badge {% if daily_entry.job_work.status == 'completed' %}bg-success{% elif daily_entry.job_work.status == 'partial_received' %}bg-info{% else %}bg-warning{% endif %}">
                                    {{ daily_entry.job_work.status.replace('_', ' ').title() }}
                                </span>
                            </td>
                        </tr>
                    </table>
                    
                    <div class="d-grid">
                        <a href="{{ url_for('jobwork.detail', id=daily_entry.job_work.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye"></i> View Full Job Work
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function approveEntry() {
    const notes = document.getElementById('inspection_notes').value;
    const classification = document.getElementById('material_classification').value;
    
    if (confirm('Are you sure you want to approve this daily entry?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("material_inspection.approve_daily_entry", entry_id=daily_entry.id) }}';
        
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'inspection_notes';
        notesInput.value = notes;
        form.appendChild(notesInput);
        
        const classificationInput = document.createElement('input');
        classificationInput.type = 'hidden';
        classificationInput.name = 'material_classification';
        classificationInput.value = classification;
        form.appendChild(classificationInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function rejectEntry() {
    const notes = document.getElementById('inspection_notes').value;
    const classification = document.getElementById('material_classification').value;
    
    if (!notes.trim()) {
        alert('Please provide inspection notes when rejecting an entry.');
        return;
    }
    
    if (confirm('Are you sure you want to reject this daily entry? This will require rework.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("material_inspection.reject_daily_entry", entry_id=daily_entry.id) }}';
        
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'inspection_notes';
        notesInput.value = notes;
        form.appendChild(notesInput);
        
        const classificationInput = document.createElement('input');
        classificationInput.type = 'hidden';
        classificationInput.name = 'material_classification';
        classificationInput.value = classification;
        form.appendChild(classificationInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}