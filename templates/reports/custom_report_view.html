{% extends "base.html" %}

{% block title %}{{ custom_report.name }} - Custom Report{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-chart-bar me-2"></i>{{ custom_report.name }}</h1>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary">{{ custom_report.report_type_display }}</span>
                        {% if custom_report.is_shared %}
                            <span class="badge bg-success">Shared</span>
                        {% endif %}
                        {% if custom_report.created_by != current_user.id %}
                            <span class="badge bg-info">By {{ custom_report.creator.username }}</span>
                        {% endif %}
                    </div>
                    {% if custom_report.description %}
                        <p class="text-muted mt-2">{{ custom_report.description }}</p>
                    {% endif %}
                </div>
                <div>
                    <div class="btn-group">
                        <a href="{{ url_for('reports.export_custom_report', report_id=custom_report.id) }}" 
                           class="btn btn-success">
                            <i class="fas fa-download"></i> Export CSV
                        </a>
                        {% if custom_report.created_by == current_user.id %}
                            <a href="{{ url_for('reports.edit_custom_report', report_id=custom_report.id) }}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        {% endif %}
                        <a href="{{ url_for('reports.custom_reports_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-table fa-2x text-primary mb-2"></i>
                    <h4 class="text-primary">{{ data|length }}</h4>
                    <small class="text-muted">Total Records</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-columns fa-2x text-info mb-2"></i>
                    <h4 class="text-info">{{ headers|length }}</h4>
                    <small class="text-muted">Data Fields</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-filter fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning">{{ config.filters|length if config.filters else 0 }}</h4>
                    <small class="text-muted">Active Filters</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-calendar fa-2x text-secondary mb-2"></i>
                    <h4 class="text-secondary">{{ custom_report.created_at.strftime('%b %d') }}</h4>
                    <small class="text-muted">Created</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Applied Filters -->
    {% if config.filters %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Applied Filters</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for filter in config.filters %}
                        <div class="col-md-4 mb-2">
                            <div class="badge bg-light text-dark border p-2 w-100">
                                <strong>{{ filter.field|replace('_', ' ')|title }}</strong> 
                                {{ filter.operator|replace('_', ' ')|title }} 
                                <em>{{ filter.value }}</em>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Report Data -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-table me-2"></i>Report Data</h5>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshReport()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <input type="text" class="form-control form-control-sm" id="searchTable" 
                               placeholder="Search in table..." style="width: 200px;">
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0" id="reportTable">
                                <thead class="table-dark">
                                    <tr>
                                        {% for header in headers %}
                                        <th class="sortable" data-column="{{ loop.index0 }}">
                                            {{ header }}
                                            <i class="fas fa-sort text-muted ms-1"></i>
                                        </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data %}
                                    <tr>
                                        {% for cell in row %}
                                        <td>
                                            {% if cell is none %}
                                                <span class="text-muted">-</span>
                                            {% elif cell is boolean %}
                                                {% if cell %}
                                                    <span class="badge bg-success">Yes</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">No</span>
                                                {% endif %}
                                            {% elif cell is number %}
                                                {{ "{:,.2f}".format(cell) if cell != cell|int else "{:,}".format(cell|int) }}
                                            {% else %}
                                                {{ cell }}
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if data|length >= 100 %}
                        <div class="p-3 border-top">
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle"></i> 
                                Showing {{ data|length }} records. Use filters to narrow down results for better performance.
                            </p>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Data Found</h5>
                            <p class="text-muted">The report query returned no results. Try adjusting your filters or criteria.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Report Configuration (for debugging/info) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#configCollapse">
                            <i class="fas fa-cog me-2"></i>Report Configuration
                            <i class="fas fa-chevron-down ms-2"></i>
                        </a>
                    </h6>
                </div>
                <div class="collapse" id="configCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Selected Fields:</h6>
                                <ul class="list-unstyled">
                                    {% for field in config.fields %}
                                    <li><i class="fas fa-check text-success me-2"></i>{{ field|replace('_', ' ')|title }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Sorting:</h6>
                                {% if config.sort_field %}
                                <p><i class="fas fa-sort me-2"></i>{{ config.sort_field|replace('_', ' ')|title }} ({{ config.sort_order|upper }})</p>
                                {% else %}
                                <p class="text-muted">No sorting applied</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Table search functionality
    const searchInput = document.getElementById('searchTable');
    const table = document.getElementById('reportTable');
    
    if (searchInput && table) {
        searchInput.addEventListener('keyup', function() {
            const filter = this.value.toLowerCase();
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                let showRow = false;
                const cells = rows[i].getElementsByTagName('td');
                
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                        showRow = true;
                        break;
                    }
                }
                
                rows[i].style.display = showRow ? '' : 'none';
            }
        });
    }
    
    // Table sorting
    const sortableHeaders = document.querySelectorAll('.sortable');
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.dataset.column);
            sortTable(column);
        });
    });
});

function sortTable(columnIndex) {
    const table = document.getElementById('reportTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    // Determine sort direction
    const header = document.querySelector(`[data-column="${columnIndex}"]`);
    const currentDirection = header.dataset.sortDirection || 'asc';
    const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
    
    // Clear all sort indicators
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort text-muted ms-1';
    });
    
    // Set sort indicator
    const icon = header.querySelector('i');
    icon.className = `fas fa-sort-${newDirection === 'asc' ? 'up' : 'down'} text-primary ms-1`;
    header.dataset.sortDirection = newDirection;
    
    // Sort rows
    rows.sort((a, b) => {
        const aVal = a.getElementsByTagName('td')[columnIndex].textContent.trim();
        const bVal = b.getElementsByTagName('td')[columnIndex].textContent.trim();
        
        // Try to parse as numbers
        const aNum = parseFloat(aVal.replace(/[,$]/g, ''));
        const bNum = parseFloat(bVal.replace(/[,$]/g, ''));
        
        let comparison = 0;
        if (!isNaN(aNum) && !isNaN(bNum)) {
            comparison = aNum - bNum;
        } else {
            comparison = aVal.localeCompare(bVal);
        }
        
        return newDirection === 'asc' ? comparison : -comparison;
    });
    
    // Reorder rows in DOM
    rows.forEach(row => tbody.appendChild(row));
}

function refreshReport() {
    location.reload();
}
</script>
{% endblock %}