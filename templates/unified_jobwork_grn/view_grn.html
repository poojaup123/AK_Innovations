{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">GRN Details - {{ grn.grn_number }}</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('unified_jobwork_grn.unified_dashboard') }}">Unified Dashboard</a></li>
                        <li class="breadcrumb-item active">GRN Details</li>
                    </ol>
                </nav>
            </div>

            <!-- GRN Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-receipt me-2"></i>
                            GRN - {{ grn.grn_number }}
                        </h5>
                        <span class="badge bg-light text-dark">{{ grn.status.replace('_', ' ').title() }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">GRN Number:</th>
                                    <td><strong>{{ grn.grn_number }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Received Date:</th>
                                    <td>{{ grn.received_date.strftime('%m/%d/%Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Received By:</th>
                                    <td>{{ grn.receiver.username }}</td>
                                </tr>
                                <tr>
                                    <th>Source Type:</th>
                                    <td>
                                        <span class="badge bg-info">{{ grn.source_type.replace('_', ' ').title() }}</span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Total Received:</th>
                                    <td><strong>{{ grn.total_quantity_received }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Total Passed:</th>
                                    <td><strong class="text-success">{{ grn.total_quantity_passed }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Total Rejected:</th>
                                    <td><strong class="text-danger">{{ grn.total_quantity_rejected }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Acceptance Rate:</th>
                                    <td>
                                        <strong class="{% if grn.acceptance_rate >= 95 %}text-success{% elif grn.acceptance_rate >= 85 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ "%.1f"|format(grn.acceptance_rate) }}%
                                        </strong>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Job Work Details (if applicable) -->
            {% if job_work %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-briefcase me-2"></i>
                        Related Job Work - {{ job_work.job_number }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Customer:</th>
                                    <td>{{ job_work.customer_name }}</td>
                                </tr>
                                <tr>
                                    <th>Process:</th>
                                    <td><span class="badge bg-info">{{ job_work.process }}</span></td>
                                </tr>
                                <tr>
                                    <th>Work Type:</th>
                                    <td>
                                        <span class="badge bg-{{ 'success' if job_work.work_type == 'in_house' else 'warning' }}">
                                            {{ job_work.work_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Total Sent:</th>
                                    <td>{{ job_work.quantity_sent }}</td>
                                </tr>
                                <tr>
                                    <th>Total Received:</th>
                                    <td>{{ job_work.quantity_received or 0 }}</td>
                                </tr>
                                <tr>
                                    <th>Rate per Unit:</th>
                                    <td>â‚¹{{ job_work.rate_per_unit }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    {% if job_work.work_type == 'in_house' and related_productions %}
                    <div class="mt-3">
                        <h6>Related Production Records:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Production Number</th>
                                        <th>Product</th>
                                        <th>Status</th>
                                        <th>Quantity Produced</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for production in related_productions %}
                                    <tr>
                                        <td>{{ production.production_number }}</td>
                                        <td>{{ production.produced_item.name }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if production.status == 'completed' else 'warning' if production.status == 'in_progress' else 'primary' }}">
                                                {{ production.status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>{{ production.quantity_produced or 0 }}</td>
                                        <td>
                                            <a href="{{ url_for('production.edit_production', id=production.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Workflow Status (for outsourced work) -->
            {% if job_work and job_work.work_type == 'outsourced' and workflow_status %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Workflow Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.material_received else 'circle text-muted' }} me-2"></i>
                                <span>Material Received</span>
                                {% if workflow_status.material_received %}
                                <small class="text-muted ms-2">({{ workflow_status.material_received_date.strftime('%m/%d/%Y') }})</small>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.grn_voucher_created else 'circle text-muted' }} me-2"></i>
                                <span>GRN Voucher Created</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.invoice_received else 'circle text-muted' }} me-2"></i>
                                <span>Invoice Received</span>
                                {% if workflow_status.invoice_received %}
                                <small class="text-muted ms-2">({{ workflow_status.invoice_received_date.strftime('%m/%d/%Y') }})</small>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.invoice_voucher_created else 'circle text-muted' }} me-2"></i>
                                <span>Invoice Voucher Created</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.payment_made else 'circle text-muted' }} me-2"></i>
                                <span>Payment Made</span>
                                {% if workflow_status.payment_made %}
                                <small class="text-muted ms-2">({{ workflow_status.payment_made_date.strftime('%m/%d/%Y') }})</small>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if workflow_status.payment_voucher_created else 'circle text-muted' }} me-2"></i>
                                <span>Payment Voucher Created</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- GRN Line Items -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Received Items
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Process</th>
                                    <th>Received</th>
                                    <th>Passed</th>
                                    <th>Rejected</th>
                                    <th>Acceptance Rate</th>
                                    <th>Status</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line_item in grn.line_items %}
                                <tr>
                                    <td>
                                        <strong>{{ line_item.item.name }}</strong><br>
                                        <small class="text-muted">{{ line_item.item.code }}</small>
                                    </td>
                                    <td>
                                        {% if line_item.process_name %}
                                        <span class="badge bg-info">{{ line_item.process_name }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td><strong>{{ line_item.quantity_received }}</strong></td>
                                    <td><strong class="text-success">{{ line_item.quantity_passed }}</strong></td>
                                    <td><strong class="text-danger">{{ line_item.quantity_rejected }}</strong></td>
                                    <td>
                                        <strong class="{% if line_item.acceptance_rate >= 95 %}text-success{% elif line_item.acceptance_rate >= 85 %}text-warning{% else %}text-danger{% endif %}">
                                            {{ "%.1f"|format(line_item.acceptance_rate) }}%
                                        </strong>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if line_item.inspection_status == 'passed' else 'warning' if line_item.inspection_status == 'partial' else 'danger' }}">
                                            {{ line_item.inspection_status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if line_item.remarks %}
                                        <small>{{ line_item.remarks[:50] }}{% if line_item.remarks|length > 50 %}...{% endif %}</small>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Next Actions -->
            {% if next_actions %}
            <div class="card mb-4">
                <div class="card-header bg-warning">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Next Actions Required
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2">
                        {% for action in next_actions %}
                        <a href="{{ action.url }}" class="btn btn-warning">
                            <i class="fas fa-arrow-right me-2"></i>{{ action.description }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('unified_jobwork_grn.unified_dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                        
                        <div class="btn-group">
                            {% if job_work %}
                            <a href="{{ url_for('unified_jobwork_grn.job_work_status', job_work_id=job_work.id) }}" class="btn btn-info">
                                <i class="fas fa-chart-line me-2"></i>Full Status
                            </a>
                            {% endif %}
                            
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Print GRN
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}