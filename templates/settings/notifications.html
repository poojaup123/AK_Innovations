{% extends "base.html" %}

{% block title %}Notification Settings - AK Innovations Factory{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('settings.dashboard') }}">Settings</a></li>
                    <li class="breadcrumb-item active">Notifications</li>
                </ol>
            </nav>
            <h2><i class="fas fa-bell"></i> Notification Settings</h2>
            <p class="text-muted">Configure SMS, Email, and WhatsApp notifications</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5>Configure Notification Services</h5>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- Email Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-envelope"></i> Email Settings (SendGrid)</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    {{ form.email_enabled(class="form-check-input") }}
                                    {{ form.email_enabled.label(class="form-check-label") }}
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.sendgrid_api_key.label(class="form-label") }}
                                            {{ form.sendgrid_api_key(class="form-control", placeholder="SG.xxxxxxxxx") }}
                                            {% if form.sendgrid_api_key.errors %}
                                                {% for error in form.sendgrid_api_key.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.sender_email.label(class="form-label") }}
                                            {{ form.sender_email(class="form-control") }}
                                            {% if form.sender_email.errors %}
                                                {% for error in form.sender_email.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.sender_name.label(class="form-label") }}
                                    {{ form.sender_name(class="form-control") }}
                                    {% if form.sender_name.errors %}
                                        {% for error in form.sender_name.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- SMS/WhatsApp Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-sms"></i> SMS & WhatsApp Settings (Twilio)</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.sms_enabled(class="form-check-input") }}
                                            {{ form.sms_enabled.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            {{ form.whatsapp_enabled(class="form-check-input") }}
                                            {{ form.whatsapp_enabled.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.twilio_account_sid.label(class="form-label") }}
                                            {{ form.twilio_account_sid(class="form-control", placeholder="ACxxxxxxxxx") }}
                                            {% if form.twilio_account_sid.errors %}
                                                {% for error in form.twilio_account_sid.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.twilio_auth_token.label(class="form-label") }}
                                            {{ form.twilio_auth_token(class="form-control", type="password") }}
                                            {% if form.twilio_auth_token.errors %}
                                                {% for error in form.twilio_auth_token.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.twilio_phone_number.label(class="form-label") }}
                                    {{ form.twilio_phone_number(class="form-control", placeholder="+1234567890") }}
                                    {% if form.twilio_phone_number.errors %}
                                        {% for error in form.twilio_phone_number.errors %}
                                            <div class="text-danger small">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Notification Preferences -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-sliders-h"></i> Notification Preferences</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.low_stock_notifications(class="form-check-input") }}
                                            {{ form.low_stock_notifications.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.order_status_notifications(class="form-check-input") }}
                                            {{ form.order_status_notifications.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            {{ form.production_notifications(class="form-check-input") }}
                                            {{ form.production_notifications.label(class="form-check-label") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Admin Recipients -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user-shield"></i> Admin Recipients</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.admin_email.label(class="form-label") }}
                                            {{ form.admin_email(class="form-control") }}
                                            {% if form.admin_email.errors %}
                                                {% for error in form.admin_email.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.admin_phone.label(class="form-label") }}
                                            {{ form.admin_phone(class="form-control", placeholder="+1234567890") }}
                                            {% if form.admin_phone.errors %}
                                                {% for error in form.admin_phone.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('settings.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Message Templates Card -->
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-edit"></i> Message Templates</h6>
                </div>
                <div class="card-body">
                    <p class="card-text">Customize the content and triggers for notification messages.</p>
                    <a href="{{ url_for('settings.notification_templates') }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Manage Message Templates
                    </a>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-info-circle"></i> Setup Instructions</h6>
                </div>
                <div class="card-body">
                    <h6>SendGrid Setup:</h6>
                    <ol class="small">
                        <li>Sign up at <a href="https://sendgrid.com" target="_blank">sendgrid.com</a></li>
                        <li>Go to Settings â†’ API Keys</li>
                        <li>Create a new API key with "Full Access"</li>
                        <li>Copy the key and paste it above</li>
                    </ol>
                    
                    <h6 class="mt-3">Twilio Setup:</h6>
                    <ol class="small">
                        <li>Sign up at <a href="https://twilio.com" target="_blank">twilio.com</a></li>
                        <li>Get your Account SID and Auth Token from Console</li>
                        <li>Buy a phone number for SMS/WhatsApp</li>
                        <li>For WhatsApp, enable WhatsApp sandbox</li>
                    </ol>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6><i class="fas fa-test-tube"></i> Test Notifications</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted">Test your notification settings:</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Test Email:</label>
                        <div class="input-group mb-2">
                            <input type="email" class="form-control" id="testEmail" placeholder="test@example.com">
                            <button class="btn btn-outline-primary" type="button" onclick="testNotification('email')">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Test SMS:</label>
                        <div class="input-group mb-2">
                            <input type="tel" class="form-control" id="testPhone" placeholder="+1234567890">
                            <button class="btn btn-outline-primary" type="button" onclick="testNotification('sms')">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Test WhatsApp:</label>
                        <div class="input-group">
                            <input type="tel" class="form-control" id="testWhatsApp" placeholder="+1234567890">
                            <button class="btn btn-outline-primary" type="button" onclick="testNotification('whatsapp')">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="testResult" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testNotification(type) {
    let recipient;
    if (type === 'email') {
        recipient = document.getElementById('testEmail').value;
    } else {
        recipient = document.getElementById(type === 'sms' ? 'testPhone' : 'testWhatsApp').value;
    }
    
    if (!recipient) {
        alert('Please enter a recipient');
        return;
    }
    
    const resultDiv = document.getElementById('testResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Sending test notification...</div>';
    
    fetch('{{ url_for("settings.test_notification") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: type,
            recipient: recipient
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + error + '</div>';
    });
}
</script>
{% endblock %}