{% extends "base.html" %}

{% block title %}Job Work Rates - Factory Management System{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-money-bill-wave"></i> Job Work Rates</h1>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('jobwork_rates.add_rate') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Rate
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    <label for="search" class="form-label">Search Items</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search }}" placeholder="Search by item name or code">
                </div>
                <div class="col-md-3">
                    <label for="process_filter" class="form-label">Process Filter</label>
                    <select class="form-select" id="process_filter" name="process_filter">
                        <option value="">All Processes</option>
                        <option value="none" {{ 'selected' if process_filter == 'none' }}>General (No specific process)</option>
                        <option value="Zinc" {{ 'selected' if process_filter == 'Zinc' }}>Zinc Plating</option>
                        <option value="Cutting" {{ 'selected' if process_filter == 'Cutting' }}>Cutting</option>
                        <option value="Bending" {{ 'selected' if process_filter == 'Bending' }}>Bending</option>
                        <option value="Welding" {{ 'selected' if process_filter == 'Welding' }}>Welding</option>
                        <option value="Painting" {{ 'selected' if process_filter == 'Painting' }}>Painting</option>
                        <option value="Assembly" {{ 'selected' if process_filter == 'Assembly' }}>Assembly</option>
                        <option value="Machining" {{ 'selected' if process_filter == 'Machining' }}>Machining</option>
                        <option value="Polishing" {{ 'selected' if process_filter == 'Polishing' }}>Polishing</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">Filter</button>
                    <a href="{{ url_for('jobwork_rates.list_rates') }}" class="btn btn-outline-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Rates Table -->
    <div class="card">
        <div class="card-body">
            {% if rates.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Item Name</th>
                                <th>Process Type</th>
                                <th>Vendor Name</th>
                                <th>Rate (₹/unit)</th>
                                <th>Notes</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rate in rates.items %}
                            <tr>
                                <td><code>{{ rate.item.code }}</code></td>
                                <td>{{ rate.item.name }}</td>
                                <td>
                                    {% if rate.process_type %}
                                        <span class="badge bg-info">{{ rate.process_type }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">All Processes</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if rate.vendor_name %}
                                        <span class="badge bg-success">{{ rate.vendor_name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><strong>₹{{ "%.2f"|format(rate.rate_per_unit) }}</strong></td>
                                <td>
                                    {% if rate.notes %}
                                        {{ rate.notes[:50] }}{% if rate.notes|length > 50 %}...{% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ rate.created_at.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('jobwork_rates.edit_rate', rate_id=rate.id) }}" 
                                           class="btn btn-outline-primary" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteRate({{ rate.id }})" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if rates.pages > 1 %}
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if rates.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('jobwork_rates.list_rates', page=rates.prev_num, search=search, process_filter=process_filter) }}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in rates.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != rates.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('jobwork_rates.list_rates', page=page_num, search=search, process_filter=process_filter) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if rates.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('jobwork_rates.list_rates', page=rates.next_num, search=search, process_filter=process_filter) }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                    <h5>No job work rates found</h5>
                    <p class="text-muted">Add rates for items to get started with job work pricing.</p>
                    <a href="{{ url_for('jobwork_rates.add_rate') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add First Rate
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function deleteRate(rateId) {
    if (confirm('Are you sure you want to delete this rate? This action cannot be undone.')) {
        fetch(`/jobwork-rates/delete/${rateId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting rate');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting rate');
        });
    }
}
</script>
{% endblock %}