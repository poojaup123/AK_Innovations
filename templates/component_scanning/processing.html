{% extends "base.html" %}

{% block title %}Processing... - Component Scanning{% endblock %}

{% block head %}
<style>
.processing-container {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    padding: 60px 20px;
}

.processing-spinner {
    width: 80px;
    height: 80px;
    border: 8px solid #f3f3f3;
    border-top: 8px solid #007bff;
    border-radius: 50%;
    animation: spin 2s linear infinite;
    margin: 0 auto 30px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.progress-steps {
    margin: 40px 0;
}

.step {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.step.active {
    opacity: 1;
    color: #007bff;
}

.step.completed {
    opacity: 1;
    color: #28a745;
}

.step-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    background: #e9ecef;
}

.step.active .step-icon {
    background: #007bff;
    color: white;
}

.step.completed .step-icon {
    background: #28a745;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="processing-container">
        <h1><i class="fas fa-cog fa-spin"></i> Processing Your Image</h1>
        <p class="text-muted mb-4">Our AI is analyzing your image to detect components...</p>
        
        <div class="processing-spinner"></div>
        
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step completed">
                <div class="step-icon">
                    <i class="fas fa-check"></i>
                </div>
                <span>Image uploaded successfully</span>
            </div>
            
            <div class="step active">
                <div class="step-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <span>AI analyzing image...</span>
            </div>
            
            <div class="step">
                <div class="step-icon">
                    <i class="fas fa-search"></i>
                </div>
                <span>Detecting components</span>
            </div>
            
            <div class="step">
                <div class="step-icon">
                    <i class="fas fa-database"></i>
                </div>
                <span>Matching with inventory</span>
            </div>
            
            <div class="step">
                <div class="step-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <span>Generating results</span>
            </div>
        </div>
        
        <!-- Session Information -->
        <div class="card">
            <div class="card-body">
                <h6>Session Details</h6>
                <p><strong>Session ID:</strong> <code>{{ detection.session_id[:8] }}...</code></p>
                <p><strong>Started:</strong> {{ detection.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                <p><strong>Confidence Threshold:</strong> {{ "%.1f"|format(detection.confidence_threshold * 100) }}%</p>
            </div>
        </div>
        
        <div class="mt-4">
            <p class="text-muted">
                <i class="fas fa-info-circle"></i> 
                This typically takes 5-15 seconds depending on image complexity.
                <br>
                Please don't close this page.
            </p>
        </div>
        
        <!-- Auto-refresh -->
        <div class="mt-3">
            <button class="btn btn-outline-primary" onclick="window.location.reload()">
                <i class="fas fa-sync"></i> Refresh Status
            </button>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 3 seconds to check if processing is complete
setTimeout(function() {
    fetch(`/component-scanning/api/detection-status/{{ detection.session_id }}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'completed') {
                window.location.href = `/component-scanning/results/{{ detection.session_id }}`;
            } else if (data.status === 'failed') {
                alert('Detection failed: ' + (data.error_message || 'Unknown error'));
                window.location.href = '/component-scanning/';
            } else {
                // Still processing, refresh page in 3 seconds
                setTimeout(() => window.location.reload(), 3000);
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            // Refresh page anyway in case of network issues
            setTimeout(() => window.location.reload(), 5000);
        });
}, 3000);
</script>
{% endblock %}