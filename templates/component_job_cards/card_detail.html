{% extends "base.html" %}

{% block title %}Job Card Details - {{ job_card.job_card_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Job Card Details</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('component_job_cards.dashboard') }}">Job Cards</a></li>
                            <li class="breadcrumb-item active">{{ job_card.job_card_number }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="updateProgress({{ job_card.id }})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Actions
                        </button>
                        <ul class="dropdown-menu">
                            {% if job_card.status == 'on_hold' %}
                                <li><a class="dropdown-item" href="#" onclick="resumeCard({{ job_card.id }})">
                                    <i class="fas fa-play text-success"></i> Resume
                                </a></li>
                            {% elif job_card.status not in ['completed'] %}
                                <li><a class="dropdown-item" href="#" onclick="holdCard({{ job_card.id }})">
                                    <i class="fas fa-pause text-warning"></i> Put on Hold
                                </a></li>
                            {% endif %}
                            <li><a class="dropdown-item" href="#" onclick="assignCard({{ job_card.id }})">
                                <i class="fas fa-user-plus text-info"></i> Reassign
                            </a></li>
                            {% if job_card.status not in ['completed'] %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="completeCard({{ job_card.id }})">
                                    <i class="fas fa-check text-success"></i> Mark Complete
                                </a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Job Card Info -->
        <div class="col-md-8">
            <!-- Status and Overview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary"></i> Job Card Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-3">{{ job_card.job_card_number }}</h4>
                            <dl class="row">
                                <dt class="col-sm-4">Component:</dt>
                                <dd class="col-sm-8">{{ job_card.component_name }}</dd>
                                
                                <dt class="col-sm-4">Production Order:</dt>
                                <dd class="col-sm-8">
                                    <a href="{{ url_for('component_job_cards.production_cards', production_id=job_card.production_id) }}">
                                        {{ job_card.production.production_number }}
                                    </a>
                                </dd>
                                
                                <dt class="col-sm-4">Status:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge {{ job_card.status_badge_class }} fs-6">{{ job_card.status|title }}</span>
                                </dd>
                                
                                <dt class="col-sm-4">Priority:</dt>
                                <dd class="col-sm-8">
                                    <span class="badge {{ job_card.priority_badge_class }} fs-6">{{ job_card.priority|title }}</span>
                                </dd>
                                
                                <dt class="col-sm-4">Work Type:</dt>
                                <dd class="col-sm-8">{{ job_card.work_type|title }}</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h5 class="mb-3">Progress Status</h5>
                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar 
                                    {% if job_card.progress_percentage >= 100 %}bg-success
                                    {% elif job_card.progress_percentage >= 75 %}bg-info
                                    {% elif job_card.progress_percentage >= 50 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ job_card.progress_percentage }}%;">
                                    {{ "%.1f"|format(job_card.progress_percentage) }}%
                                </div>
                            </div>
                            
                            <dl class="row">
                                <dt class="col-sm-6">Planned Quantity:</dt>
                                <dd class="col-sm-6">{{ job_card.planned_quantity }} {{ job_card.planned_uom }}</dd>
                                
                                <dt class="col-sm-6">Consumed:</dt>
                                <dd class="col-sm-6">{{ job_card.actual_quantity_consumed }} {{ job_card.actual_uom }}</dd>
                                
                                <dt class="col-sm-6">Remaining:</dt>
                                <dd class="col-sm-6">{{ job_card.remaining_quantity }} {{ job_card.actual_uom }}</dd>
                                
                                <dt class="col-sm-6">Scrap:</dt>
                                <dd class="col-sm-6">{{ job_card.scrap_quantity }} {{ job_card.actual_uom }}</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline and Dates -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar text-primary"></i> Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-6">Created Date:</dt>
                                <dd class="col-sm-6">{{ job_card.created_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                                
                                <dt class="col-sm-6">Target Date:</dt>
                                <dd class="col-sm-6">
                                    {{ job_card.target_completion_date.strftime('%Y-%m-%d') }}
                                    {% if job_card.is_delayed %}
                                        <span class="badge bg-danger ms-2">Overdue</span>
                                    {% elif job_card.days_remaining == 0 %}
                                        <span class="badge bg-warning ms-2">Due Today</span>
                                    {% elif job_card.days_remaining and job_card.days_remaining < 3 %}
                                        <span class="badge bg-warning ms-2">Due Soon</span>
                                    {% endif %}
                                </dd>
                                
                                {% if job_card.started_at %}
                                <dt class="col-sm-6">Started:</dt>
                                <dd class="col-sm-6">{{ job_card.started_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                                {% endif %}
                                
                                {% if job_card.completed_at %}
                                <dt class="col-sm-6">Completed:</dt>
                                <dd class="col-sm-6">{{ job_card.completed_at.strftime('%Y-%m-%d %H:%M') }}</dd>
                                {% endif %}
                            </dl>
                        </div>
                        <div class="col-md-6">
                            {% if job_card.days_remaining is not none %}
                                <div class="text-center">
                                    {% if job_card.days_remaining < 0 %}
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>{{ -job_card.days_remaining }} days overdue</strong>
                                        </div>
                                    {% elif job_card.days_remaining == 0 %}
                                        <div class="alert alert-warning">
                                            <i class="fas fa-clock"></i>
                                            <strong>Due Today</strong>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-calendar-day"></i>
                                            <strong>{{ job_card.days_remaining }} days remaining</strong>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Process Steps -->
            {% if process_steps %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol text-primary"></i> Process Steps
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for step in process_steps %}
                        <div class="list-group-item 
                            {% if loop.index == job_card.current_process_step %}list-group-item-warning{% endif %}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">
                                    <span class="badge bg-primary me-2">{{ step.step_number }}</span>
                                    {{ step.process_name }}
                                </h6>
                                {% if step.process_code %}
                                    <small class="text-muted">{{ step.process_code }}</small>
                                {% endif %}
                            </div>
                            {% if step.operation_description %}
                                <p class="mb-1">{{ step.operation_description }}</p>
                            {% endif %}
                            <div class="row mt-2">
                                {% if step.setup_time_minutes %}
                                <div class="col-auto">
                                    <small class="text-muted">Setup: {{ step.setup_time_minutes }} min</small>
                                </div>
                                {% endif %}
                                {% if step.run_time_minutes %}
                                <div class="col-auto">
                                    <small class="text-muted">Run: {{ step.run_time_minutes }} min</small>
                                </div>
                                {% endif %}
                                {% if step.is_outsourced %}
                                <div class="col-auto">
                                    <span class="badge bg-info">Outsourced</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Assignment Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user-cog text-primary"></i> Assignment
                    </h5>
                </div>
                <div class="card-body">
                    {% if job_card.assigned_worker %}
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-user text-secondary me-2"></i>
                            <div>
                                <strong>{{ job_card.assigned_worker.username }}</strong>
                                <br><small class="text-muted">In-House Worker</small>
                            </div>
                        </div>
                    {% elif job_card.assigned_vendor %}
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-building text-info me-2"></i>
                            <div>
                                <strong>{{ job_card.assigned_vendor.name }}</strong>
                                <br><small class="text-muted">External Vendor</small>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-user-plus fa-2x text-muted mb-2"></i>
                            <p class="text-muted">Not assigned</p>
                            <button class="btn btn-primary btn-sm" onclick="assignCard({{ job_card.id }})">
                                Assign Now
                            </button>
                        </div>
                    {% endif %}
                    
                    {% if job_card.assigned_department %}
                        <div class="mt-3">
                            <small class="text-muted">Department:</small>
                            <div>{{ job_card.assigned_department }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Material Availability -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes text-primary"></i> Material Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Available Stock:</span>
                        <strong>{{ available_stock }} {{ job_card.planned_uom }}</strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>Required:</span>
                        <strong>{{ job_card.remaining_quantity }} {{ job_card.planned_uom }}</strong>
                    </div>
                    
                    <div class="progress mb-2" style="height: 20px;">
                        {% set availability_percentage = (available_stock / job_card.remaining_quantity * 100) if job_card.remaining_quantity > 0 else 100 %}
                        <div class="progress-bar 
                            {% if availability_percentage >= 100 %}bg-success
                            {% elif availability_percentage >= 75 %}bg-info
                            {% elif availability_percentage >= 25 %}bg-warning
                            {% else %}bg-danger{% endif %}" 
                             role="progressbar" 
                             style="width: {{ [availability_percentage, 100]|min }}%;">
                            {{ "%.0f"|format([availability_percentage, 100]|min) }}%
                        </div>
                    </div>
                    
                    {% if stock_status == 'sufficient' %}
                        <div class="alert alert-success alert-sm">
                            <i class="fas fa-check-circle"></i> Sufficient stock available
                        </div>
                    {% else %}
                        <div class="alert alert-warning alert-sm">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Short by {{ stock_shortage }} {{ job_card.planned_uom }}
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Cost Tracking -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-rupee-sign text-primary"></i> Cost Tracking
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Estimated Cost:</span>
                        <strong>₹{{ "%.2f"|format(job_card.estimated_cost) }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Actual Cost:</span>
                        <strong>₹{{ "%.2f"|format(job_card.actual_cost) }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Labor Cost:</span>
                        <strong>₹{{ "%.2f"|format(job_card.labor_cost) }}</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span><strong>Total:</strong></span>
                        <strong>₹{{ "%.2f"|format(job_card.actual_cost + job_card.labor_cost) }}</strong>
                    </div>
                </div>
            </div>

            <!-- Quality Status -->
            {% if job_card.inspection_required %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search text-primary"></i> Quality Control
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span>Quality Status:</span>
                        <span class="badge 
                            {% if job_card.quality_status == 'passed' %}bg-success
                            {% elif job_card.quality_status == 'failed' %}bg-danger
                            {% elif job_card.quality_status == 'rework' %}bg-warning
                            {% else %}bg-secondary{% endif %} ms-2">
                            {{ job_card.quality_status|title }}
                        </span>
                    </div>
                    
                    {% if job_card.inspected_by %}
                        <small class="text-muted">Inspected by: {{ job_card.inspector.username }}</small><br>
                        <small class="text-muted">Date: {{ job_card.inspection_date.strftime('%Y-%m-%d %H:%M') }}</small>
                    {% else %}
                        <small class="text-warning">Inspection pending</small>
                    {% endif %}
                    
                    {% if job_card.inspection_notes %}
                        <div class="mt-3">
                            <small class="text-muted">Notes:</small>
                            <div class="border rounded p-2 mt-1">
                                {{ job_card.inspection_notes }}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Include Modals -->
{% include 'component_job_cards/modals/progress_modal.html' %}
{% include 'component_job_cards/modals/assign_modal.html' %}
{% include 'component_job_cards/modals/hold_modal.html' %}
{% include 'component_job_cards/modals/resume_modal.html' %}
{% include 'component_job_cards/modals/complete_modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/component_job_cards.js') }}"></script>
{% endblock %}