{% extends "base.html" %}

{% block title %}{{ title }} - Factory Management System{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-cogs"></i> {{ title }}</h1>
            <p class="text-muted">Create and manage production orders with intelligent BOM analysis and smart suggestions</p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('production.list_productions') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Productions
            </a>
        </div>
    </div>

    <form method="POST">
        {{ form.hidden_tag() }}
        
        <!-- SECTION 1: PRODUCTION ORDER FORM -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #4285f4; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Section 1: Production Order Form
                </h5>
                <small>Enter production order details, quantities, and scheduling information</small>
            </div>
            <div class="card-body">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.production_number.label(class="form-label") }}
                                {{ form.production_number(class="form-control") }}
                                {% if form.production_number.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.production_number.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.item_id.label(class="form-label") }}
                                {{ form.item_id(class="form-select", id="item_id") }}
                                {% if form.item_id.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.item_id.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.quantity_planned.label(class="form-label") }}
                                {{ form.quantity_planned(class="form-control") }}
                                {% if form.quantity_planned.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity_planned.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.planned_uom.label(class="form-label") }}
                                {{ form.planned_uom(class="form-select") }}
                                {% if form.planned_uom.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.planned_uom.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.production_date.label(class="form-label") }}
                                {{ form.production_date(class="form-control") }}
                                {% if form.production_date.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.production_date.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                                {% if form.status.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.status.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Production Results - Only show when editing existing production or status is not 'planned' -->
                        <div class="row" id="production-results" {% if not production and (not form.status.data or form.status.data == 'planned') %}style="display: none;"{% endif %}>
                            <div class="col-12 mb-2">
                                <h6 class="text-muted">Production Results (Fill during/after production)</h6>
                            </div>
                            <div class="col-md-3 mb-3">
                                {{ form.quantity_produced.label(class="form-label") }}
                                {{ form.quantity_produced(class="form-control") }}
                                {% if form.quantity_produced.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity_produced.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.produced_uom.label(class="form-label") }}
                                {{ form.produced_uom(class="form-select") }}
                                {% if form.produced_uom.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.produced_uom.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.quantity_good.label(class="form-label") }}
                                {{ form.quantity_good(class="form-control") }}
                                {% if form.quantity_good.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity_good.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.good_uom.label(class="form-label") }}
                                {{ form.good_uom(class="form-select") }}
                                {% if form.good_uom.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.good_uom.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.quantity_damaged.label(class="form-label") }}
                                {{ form.quantity_damaged(class="form-control") }}
                                {% if form.quantity_damaged.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.quantity_damaged.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.damaged_uom.label(class="form-label") }}
                                {{ form.damaged_uom(class="form-select") }}
                                {% if form.damaged_uom.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.damaged_uom.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Scrap Tracking Section -->
                        <div class="row">
                            <div class="col-12 mb-2">
                                <h6 class="text-muted"><i class="fas fa-recycle text-warning"></i> Scrap & Waste Tracking</h6>
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.scrap_quantity.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.scrap_quantity(class="form-control", placeholder="Weight-based scrap generated") }}
                                    <span class="input-group-text text-muted">
                                        <i class="fas fa-recycle"></i>
                                    </span>
                                </div>
                                {% if form.scrap_quantity.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.scrap_quantity.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="text-muted">Track scrap material generated during production</small>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                {{ form.scrap_uom.label(class="form-label") }}
                                {{ form.scrap_uom(class="form-select") }}
                                {% if form.scrap_uom.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.scrap_uom.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="text-muted">Typically measured in weight units (kg, g)</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="3") }}
                            {% if form.notes.errors %}
                                <div class="text-danger small">
                                    {% for error in form.notes.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('production.list_productions') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="previewForm()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> {{ 'Update' if production else 'Save' }} Production Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SECTION 2: MATERIAL REQUIREMENTS ANALYSIS -->
        {% if bom_items or material_shortages %}
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #34a853; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>
                    Section 2: Material Requirements Analysis
                </h5>
                <small>BOM breakdown, material availability, and shortage analysis</small>
            </div>
            <div class="card-body">
                {% if bom_items %}
                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-3">
                            <i class="fas fa-sitemap text-primary"></i> Bill of Materials
                            {% if selected_item %}
                            <small class="text-muted">for {{ selected_item.code }} - {{ selected_item.name }}</small>
                            {% endif %}
                        </h6>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-hover" data-bom-output="{{ selected_item.bom_set[0].output_quantity if selected_item and selected_item.bom_set else 1.0 }}">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-box"></i> Material</th>
                                <th><i class="fas fa-calculator"></i> Per Unit</th>
                                <th><i class="fas fa-warehouse"></i> Available</th>
                                <th><i class="fas fa-tags"></i> Batches</th>
                                <th><i class="fas fa-check-circle"></i> Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bom_item in bom_items %}
                            {% set planned_qty = 1 %}
                            {% if production %}
                                {% set planned_qty = production.quantity_planned %}
                            {% elif form.quantity_planned.data %}
                                {% set planned_qty = form.quantity_planned.data %}
                            {% endif %}
                            {% set material_qty_per_output = bom_item.quantity_required or bom_item.qty_required %}
                            {% set bom_output_qty = bom_items[0].bom.output_quantity if bom_items and bom_items[0].bom else 1.0 %}
                            {% set total_required = (planned_qty / bom_output_qty) * material_qty_per_output %}
                            {% set available = (bom_item.item.qty_raw or 0) + (bom_item.item.qty_finished or 0) if bom_item.item.qty_raw is not none else (bom_item.item.current_stock or 0) %}
                            {% set is_sufficient = available >= total_required %}
                            <tr class="{% if not is_sufficient %}table-danger{% endif %}">
                                <td>
                                    <small class="text-muted">{{ bom_item.item.code }}</small><br>
                                    <strong>{{ bom_item.item.name }}</strong>
                                </td>
                                <td>{{ bom_item.quantity_required }} {{ bom_item.item.unit_of_measure }}</td>
                                <td>
                                    <strong>{{ available }}</strong> {{ bom_item.item.unit_of_measure }}
                                    <br><small class="text-muted">Need: {{ total_required }}</small>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            onclick="showBatchDetails('{{ bom_item.item.code }}')" 
                                            title="View available batches">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <div id="batch-info-{{ bom_item.item.code }}" class="mt-1" style="display: none;">
                                        <small class="text-muted">Loading batches...</small>
                                    </div>
                                </td>
                                <td>
                                    {% if is_sufficient %}
                                        <span class="badge bg-success"><i class="fas fa-check"></i> OK</span>
                                    {% else %}
                                        <span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Short</span>
                                        <br><small class="text-danger">{{ total_required - available }} short</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                
                {% if material_shortages %}
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="mb-3">
                            <i class="fas fa-exclamation-triangle text-danger"></i> Material Shortages Detected
                        </h6>
                    </div>
                </div>
                <div class="alert alert-warning border-left-danger">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Material shortages detected!</strong> The following components are insufficient:
                </div>
                
                <div class="row">
                    {% for shortage in material_shortages %}
                    <div class="col-lg-6 mb-3">
                        <div class="card border-danger">
                            <div class="card-body">
                                <h6 class="card-title text-danger mb-2">
                                    <i class="fas fa-box"></i> {{ shortage.item_code }} - {{ shortage.item_name }}
                                </h6>
                                <div class="mb-2">
                                    <small class="text-muted">Required:</small> <span class="fw-bold text-dark">{{ shortage.required_qty|int }} {{ shortage.unit }}</span><br>
                                    <small class="text-muted">Direct Stock:</small> {{ shortage.direct_available|int }} {{ shortage.unit }}
                                    {% if shortage.manufacturable_qty > 0 %}
                                        + <span class="text-success">{{ shortage.manufacturable_qty|int }} manufacturable</span>
                                    {% endif %}
                                    = {{ shortage.total_available|int }} total<br>
                                    <small class="text-muted">Shortage:</small> <span class="text-danger fw-bold">{{ shortage.shortage_qty|int }} {{ shortage.unit }}</span>
                                </div>
                                
                                {% if shortage.can_manufacture and shortage.manufacturable_qty > 0 %}
                                <div class="mb-2">
                                    <span class="badge bg-success"><i class="fas fa-cogs"></i> Can Manufacture</span>
                                    <small class="text-success d-block">Raw materials available for production</small>
                                </div>
                                {% endif %}
                                
                                {% if shortage.raw_materials %}
                                <div class="mt-2">
                                    <small class="text-muted fw-bold">Raw Materials Available:</small>
                                    {% for raw in shortage.raw_materials %}
                                    {% if raw.available > 0 %}
                                    <div class="mt-1">
                                        <small class="text-success">
                                            <i class="fas fa-check-circle"></i> {{ raw.raw_material }}: {{ raw.available|int }} available (can make {{ raw.can_make|int }} units)
                                        </small>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- SECTION 3: SMART JOB WORK SUGGESTIONS -->
        {% if job_work_suggestions %}
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #fbbc04; color: black;">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Section 3: Smart Job Work Suggestions
                </h5>
                <small>AI-powered suggestions to resolve material shortages through manufacturing</small>
            </div>
            <div class="card-body">
                <div class="alert alert-success border-left-success">
                    <i class="fas fa-magic"></i> <strong>Great news!</strong> You can create job works to manufacture missing components using available raw materials.
                </div>
                
                <div class="row">
                    {% for suggestion in job_work_suggestions %}
                    <div class="col-lg-6 mb-3">
                        <div class="card border-success h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="text-success mb-2">
                                            <i class="fas fa-cogs"></i> {{ suggestion.component }}
                                        </h6>
                                        <p class="text-muted mb-2">{{ suggestion.message }}</p>
                                        <span class="badge bg-info">Suggested Qty: {{ suggestion.suggested_qty|int }}</span>
                                    </div>
                                    <a href="{{ url_for('jobwork.add_job_work') }}?component={{ suggestion.component_code }}&quantity={{ suggestion.suggested_qty|int }}" 
                                       class="btn btn-success btn-sm">
                                        <i class="fas fa-plus"></i> Create Job Work
                                    </a>
                                </div>
                                
                                <div class="mt-3">
                                    <h6 class="text-muted mb-2"><i class="fas fa-boxes"></i> Raw Materials Available:</h6>
                                    {% for raw in suggestion.raw_materials_needed %}
                                    {% if raw.available > 0 %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <small class="text-success">
                                            <i class="fas fa-check-circle"></i> {{ raw.raw_material }}
                                        </small>
                                        <small class="text-muted">
                                            {{ raw.available|int }} sheets → {{ raw.can_make|int }} units
                                        </small>
                                    </div>
                                    {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
    </form>
</div>

<script src="{{ url_for('static', filename='js/preview-system.js') }}"></script>
<script>
// Initialize preview system for production orders
document.addEventListener('DOMContentLoaded', function() {
    initializePreviewSystem('production');
});
</script>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const statusSelect = document.getElementById('status');
    const productionResults = document.getElementById('production-results');
    const itemSelect = document.getElementById('item_id');
    const quantityInput = document.getElementById('quantity_planned');
    
    // Handle status change to show/hide production results
    if (statusSelect && productionResults) {
        statusSelect.addEventListener('change', function() {
            if (this.value === 'planned') {
                productionResults.style.display = 'none';
                // Clear the production result fields when hiding
                const productionFields = ['quantity_produced', 'quantity_good', 'quantity_damaged'];
                productionFields.forEach(fieldName => {
                    const field = document.getElementById(fieldName);
                    if (field) field.value = '0.0';
                });
            } else {
                productionResults.style.display = 'block';
            }
        });
    }
    
    // Add real-time material availability checking
    function checkMaterialAvailability() {
        const itemId = itemSelect ? itemSelect.value : null;
        const quantity = quantityInput ? parseFloat(quantityInput.value) || 1 : 1;
        
        if (itemId && quantity > 0) {
            // Update the BOM table calculations dynamically
            const bomRows = document.querySelectorAll('tbody tr');
            bomRows.forEach(row => {
                const perUnitCell = row.cells[1];
                const availableCell = row.cells[2];
                const statusCell = row.cells[3];
                
                if (perUnitCell && availableCell && statusCell) {
                    const perUnitText = perUnitCell.textContent.trim();
                    const perUnitMatch = perUnitText.match(/^([\d.]+)/);
                    const perUnit = perUnitMatch ? parseFloat(perUnitMatch[1]) : 0;
                    
                    const availableMatch = availableCell.innerHTML.match(/<strong>([\d.]+)<\/strong>/);
                    const available = availableMatch ? parseFloat(availableMatch[1]) : 0;
                    
                    // Calculate based on BOM output quantity (e.g., 1 sheet = 400 pieces)
                    const bomOutputQty = parseFloat(document.querySelector('[data-bom-output]')?.dataset.bomOutput) || 1.0;
                    const totalRequired = (quantity / bomOutputQty) * perUnit;
                    const isSufficient = available >= totalRequired;
                    
                    // Update the "Need" text
                    availableCell.innerHTML = availableCell.innerHTML.replace(
                        /Need: [\d.]+/,
                        `Need: ${totalRequired.toFixed(2)}`
                    );
                    
                    // Update row styling and status
                    if (isSufficient) {
                        row.className = '';
                        statusCell.innerHTML = '<span class="badge bg-success">✓ OK</span>';
                    } else {
                        row.className = 'table-danger';
                        const shortage = totalRequired - available;
                        statusCell.innerHTML = `<span class="badge bg-danger">⚠ Short</span><br><small class="text-danger">${shortage.toFixed(2)} short</small>`;
                    }
                }
            });
        }
    }
    
    // Add event listeners for real-time updates
    if (quantityInput) {
        quantityInput.addEventListener('input', checkMaterialAvailability);
        quantityInput.addEventListener('change', checkMaterialAvailability);
    }
    
    if (itemSelect) {
        itemSelect.addEventListener('change', function() {
            // Reload page to get new BOM data when item changes  
            if (this.value && this.value !== '0') {
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('item_id', this.value);
                window.location.href = currentUrl.toString();
            }
        });
    }
});

// Function to show batch details
function showBatchDetails(itemCode) {
    const batchInfo = document.getElementById(`batch-info-${itemCode}`);
    const button = event.target.closest('button');
    
    if (batchInfo.style.display === 'none') {
        batchInfo.style.display = 'block';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
        
        // Load batch data via API
        fetch(`/inventory/api/item-batch-details/${itemCode}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.batches && data.batches.length > 0) {
                    let batchHtml = '<div class="small">';
                    data.batches.forEach(batch => {
                        const totalQty = batch.qty_raw + batch.qty_finished;
                        if (totalQty > 0) {
                            batchHtml += `<div class="badge bg-light text-dark me-1 mb-1">
                                ${batch.batch_code}: ${totalQty.toFixed(1)} ${batch.uom}
                            </div>`;
                        }
                    });
                    batchHtml += '</div>';
                    batchInfo.innerHTML = batchHtml;
                } else {
                    batchInfo.innerHTML = '<small class="text-muted">No batches available</small>';
                }
            })
            .catch(error => {
                console.error('Error loading batch details:', error);
                batchInfo.innerHTML = '<small class="text-danger">Error loading batches</small>';
            });
    } else {
        batchInfo.style.display = 'none';
        button.innerHTML = '<i class="fas fa-eye"></i> View';
    }
}

// Auto-load BOM when page loads with item_id parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const itemId = urlParams.get('item_id');
    const itemSelect = document.getElementById('item_id');
    
    if (itemId && itemSelect) {
        itemSelect.value = itemId;
        // Trigger change event to load BOM if needed
        itemSelect.dispatchEvent(new Event('change'));
    }
                    // Set a flag to indicate we want to see BOM
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'preview_bom';
                    hiddenInput.value = '1';
                    form.appendChild(hiddenInput);
                    
                    // Submit form to reload with BOM data
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.click();
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
