{% extends "base.html" %}

{% block title %}Packing Optimization - Factory Management System{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title"><i class="fas fa-cubes"></i> Packing Optimization</h1>
    <p class="page-subtitle">Material cutting and layout optimization using advanced algorithms</p>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Items</h5>
                        <h3>{{ stats.total_items }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">BOMs</h5>
                        <h3>{{ stats.total_boms }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cogs fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">BOM Items</h5>
                        <h3>{{ stats.bom_items }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Recent POs</h5>
                        <h3>{{ stats.recent_pos }}</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Optimization Modules -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cut"></i> Material Cutting Optimization
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Optimize cutting patterns for sheet materials (metal, wood, glass) to minimize waste and reduce costs.</p>
                <div class="mb-3">
                    <strong>Features:</strong>
                    <ul class="mt-2">
                        <li>Multiple packing algorithms (Skyline, MaxRects, Guillotine)</li>
                        <li>Support for different sheet sizes</li>
                        <li>Automatic rotation for optimal fit</li>
                        <li>Cost savings calculations</li>
                        <li>Visual cutting layouts</li>
                    </ul>
                </div>
                <div class="btn-group w-100">
                    <a href="{{ url_for('packing.material_cutting') }}" class="btn btn-primary">
                        <i class="fas fa-cut"></i> Start Optimization
                    </a>
                    <a href="{{ url_for('packing.demo') }}" class="btn btn-outline-primary">
                        <i class="fas fa-play"></i> View Demo
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-puzzle-piece"></i> Advanced Sheet Nesting
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">AI-powered nesting for irregular shapes using image processing and advanced optimization algorithms.</p>
                <div class="mb-3">
                    <strong>Features:</strong>
                    <ul class="mt-2">
                        <li>Irregular shape detection via OpenCV</li>
                        <li>Image-based analysis with scikit-image</li>
                        <li>Scrap percentage calculation</li>
                        <li>SVG layout generation</li>
                        <li>Multiple part optimization</li>
                    </ul>
                </div>
                <div class="btn-group w-100">
                    <a href="{{ url_for('packing.sheet_nesting') }}" class="btn btn-info">
                        <i class="fas fa-puzzle-piece"></i> Start Nesting
                    </a>
                    <a href="{{ url_for('packing.nesting_history') }}" class="btn btn-outline-info">
                        <i class="fas fa-history"></i> History
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Additional Row for Inventory Layout -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-warehouse"></i> Inventory Layout Optimization
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Optimize warehouse and storage layout to maximize space utilization and improve workflow efficiency.</p>
                <div class="mb-3">
                    <strong>Features:</strong>
                    <ul class="mt-2">
                        <li>Storage space optimization</li>
                        <li>Item placement algorithms</li>
                        <li>Accessibility optimization</li>
                        <li>Visual layout diagrams</li>
                        <li>Space utilization metrics</li>
                    </ul>
                </div>
                <div class="btn-group w-100">
                    <a href="{{ url_for('packing.inventory_layout') }}" class="btn btn-success">
                        <i class="fas fa-warehouse"></i> Optimize Layout
                    </a>
                    <button class="btn btn-outline-success" onclick="showLayoutDemo()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i> Optimization Analytics
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">Track and analyze optimization performance with detailed metrics and efficiency reports.</p>
                <div class="mb-3">
                    <strong>Metrics:</strong>
                    <ul class="mt-2">
                        <li>Material waste reduction</li>
                        <li>Cost savings analysis</li>
                        <li>Efficiency trends</li>
                        <li>Comparison reports</li>
                        <li>ROI calculations</li>
                    </ul>
                </div>
                <div class="btn-group w-100">
                    <button class="btn btn-warning" onclick="showAnalytics()">
                        <i class="fas fa-chart-bar"></i> View Analytics
                    </button>
                    <button class="btn btn-outline-warning" onclick="exportReport()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Quick Optimization Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if recent_pos %}
                    <div class="col-md-6">
                        <h6>Optimize from Purchase Orders</h6>
                        <div class="list-group">
                            {% for po in recent_pos %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ po.po_number }}</strong><br>
                                    <small class="text-muted">{{ po.supplier.name if po.supplier else 'No Supplier' }}</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="optimizeFromPO({{ po.id }})">
                                    <i class="fas fa-cut"></i> Optimize
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="col-md-6">
                        <h6>Recently Added Items</h6>
                        <div class="list-group">
                            {% for item in recent_items %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ item.code }}</strong> - {{ item.name }}<br>
                                    <small class="text-muted">{{ item.item_type|title }} | Stock: {{ item.current_stock or 0 }}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success" onclick="addToLayout('{{ item.id }}')">
                                        <i class="fas fa-plus"></i> Layout
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Algorithm Information -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Packing Algorithms</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="badge bg-primary p-3 mb-3">
                                <i class="fas fa-mountain fa-2x"></i>
                            </div>
                            <h6>Skyline Algorithm</h6>
                            <p class="small text-muted">Best balance of speed and quality. Maintains skyline nodes for efficient packing.</p>
                            <div class="badge bg-light text-dark">Recommended</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="badge bg-success p-3 mb-3">
                                <i class="fas fa-th fa-2x"></i>
                            </div>
                            <h6>MaxRects Algorithm</h6>
                            <p class="small text-muted">Highest packing quality. Tracks maximum available rectangles for optimal placement.</p>
                            <div class="badge bg-light text-dark">Best Quality</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="badge bg-warning p-3 mb-3">
                                <i class="fas fa-tachometer-alt fa-2x"></i>
                            </div>
                            <h6>Guillotine Algorithm</h6>
                            <p class="small text-muted">Fastest performance. Uses guillotine cuts for rapid processing of large datasets.</p>
                            <div class="badge bg-light text-dark">Fastest</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Optimizing...</p>
            </div>
        </div>
    </div>
</div>

<script>
function optimizeFromPO(poId) {
    $('#loadingModal').modal('show');
    
    fetch(`/packing/api/optimize-from-po/${poId}`)
        .then(response => response.json())
        .then(data => {
            $('#loadingModal').modal('hide');
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Store results in session storage for the material cutting page
                sessionStorage.setItem('optimizationResult', JSON.stringify(data));
                window.location.href = '{{ url_for("packing.material_cutting") }}';
            }
        })
        .catch(error => {
            $('#loadingModal').modal('hide');
            console.error('Error:', error);
            alert('Optimization failed: ' + error.message);
        });
}

function addToLayout(itemId) {
    // Add item to layout optimization (store in session)
    let layoutItems = JSON.parse(sessionStorage.getItem('layoutItems') || '[]');
    layoutItems.push(itemId);
    sessionStorage.setItem('layoutItems', JSON.stringify(layoutItems));
    
    alert('Item added to layout optimization. Go to Inventory Layout page to continue.');
}

function showLayoutDemo() {
    alert('Layout demo: This would show a visual preview of warehouse optimization features.');
}
</script>
{% endblock %}