{% extends "base.html" %}

{% block title %}Advanced Sheet Nesting - Factory Management System{% endblock %}

{% block head %}
<style>
.upload-area {
    border: 2px dashed #28a745;
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #20c997;
    background: #e8f5e9;
}

.upload-area.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.image-preview {
    max-width: 200px;
    max-height: 150px;
    border-radius: 5px;
    margin: 10px;
}

.part-input-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.result-card {
    display: none;
}

.efficiency-metric {
    font-size: 1.5rem;
    font-weight: bold;
}

.svg-preview {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    max-width: 100%;
    height: auto;
}

.loading-spinner {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
}

#loadingSpinner {
    display: none !important;
    visibility: hidden !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-puzzle-piece"></i> Advanced Sheet Nesting Optimizer</h1>
            <p class="text-muted">Upload images of sheets and parts to optimize cutting layouts with scrap analysis</p>
        </div>
        <div class="col-auto">
            <div class="btn-group" role="group">
                <a href="{{ url_for('packing.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Packing
                </a>
                <a href="{{ url_for('packing.nesting_history') }}" class="btn btn-info">
                    <i class="fas fa-history"></i> History
                </a>
            </div>
        </div>
    </div>

    <!-- Upload Form -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Upload Sheet Image</h5>
                </div>
                <div class="card-body">
                    <div class="upload-area" id="sheetUploadArea">
                        <i class="fas fa-cloud-upload-alt fa-3x text-success mb-3"></i>
                        <h5>Drop sheet image here or click to upload</h5>
                        <p class="text-muted">Supports JPG, PNG, BMP formats</p>
                        <input type="file" id="sheetImageInput" accept="image/*" style="display: none;">
                    </div>
                    <div id="sheetPreview" class="mt-3"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-shapes"></i> Upload Part Images</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="addPartBtn">
                        <i class="fas fa-plus"></i> Add Part
                    </button>
                </div>
                <div class="card-body">
                    <div id="partInputs">
                        <div class="part-input-section" data-part-index="0">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="upload-area part-upload-area" data-part-index="0">
                                        <i class="fas fa-shapes fa-2x text-primary mb-2"></i>
                                        <p><strong>Part 1</strong></p>
                                        <p class="text-muted small">Drop image or click to upload</p>
                                        <input type="file" class="part-image-input" accept="image/*" style="display: none;">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control part-quantity" min="1" value="1">
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-part-btn" style="display: none;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                            <div class="part-preview mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Button -->
    <div class="row mb-4">
        <div class="col text-center">
            <button type="button" class="btn btn-lg btn-success" id="analyzeBtn" disabled>
                <i class="fas fa-cogs"></i> Analyze Nesting Optimization
            </button>
            <div class="loading-spinner mt-3" id="loadingSpinner" style="visibility: hidden; display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Analyzing...</span>
                </div>
                <p class="mt-2">Processing images and optimizing layout...</p>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="result-card">
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Nesting Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="resultsSummary">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-eye"></i> Visual Layout</h5>
                    </div>
                    <div class="card-body">
                        <div id="svgLayoutContainer" class="text-center">
                            <!-- SVG layout will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Efficiency Analysis</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="efficiencyChart" width="300" height="300"></canvas>
                        <div class="mt-3" id="efficiencyMetrics">
                            <!-- Efficiency metrics will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="alert alert-danger" id="errorAlert" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorMessage"></span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let partCounter = 1;
let efficiencyChart = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeUploadAreas();
    setupEventListeners();
    
    // Ensure loading spinner is hidden on page load
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'none';
        loadingSpinner.style.visibility = 'hidden';
        loadingSpinner.style.opacity = '0';
    }
});

function initializeUploadAreas() {
    // Sheet upload area
    const sheetUploadArea = document.getElementById('sheetUploadArea');
    const sheetInput = document.getElementById('sheetImageInput');
    
    sheetUploadArea.addEventListener('click', () => sheetInput.click());
    sheetUploadArea.addEventListener('dragover', handleDragOver);
    sheetUploadArea.addEventListener('drop', (e) => handleDrop(e, sheetInput));
    sheetInput.addEventListener('change', (e) => handleSheetImageSelect(e));
    
    // Part upload areas
    initializePartUploadArea(0);
}

function initializePartUploadArea(index) {
    const uploadArea = document.querySelector(`[data-part-index="${index}"] .part-upload-area`);
    const input = document.querySelector(`[data-part-index="${index}"] .part-image-input`);
    
    if (uploadArea && input) {
        uploadArea.addEventListener('click', () => input.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', (e) => handleDrop(e, input));
        input.addEventListener('change', (e) => handlePartImageSelect(e, index));
    }
}

function setupEventListeners() {
    document.getElementById('addPartBtn').addEventListener('click', addPartInput);
    document.getElementById('analyzeBtn').addEventListener('click', analyzeNesting);
    
    // Remove part buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-part-btn')) {
            const partSection = e.target.closest('.part-input-section');
            if (document.querySelectorAll('.part-input-section').length > 1) {
                partSection.remove();
                updateAnalyzeButton();
            }
        }
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDrop(e, input) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        input.files = files;
        input.dispatchEvent(new Event('change'));
    }
}

function handleSheetImageSelect(e) {
    const file = e.target.files[0];
    if (file) {
        displayImagePreview(file, document.getElementById('sheetPreview'));
        updateAnalyzeButton();
    }
}

function handlePartImageSelect(e, index) {
    const file = e.target.files[0];
    if (file) {
        const previewContainer = document.querySelector(`[data-part-index="${index}"] .part-preview`);
        displayImagePreview(file, previewContainer);
        updateAnalyzeButton();
    }
}

function displayImagePreview(file, container) {
    const reader = new FileReader();
    reader.onload = function(e) {
        container.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="Preview">`;
    };
    reader.readAsDataURL(file);
}

function addPartInput() {
    partCounter++;
    const partInputs = document.getElementById('partInputs');
    
    const newPartHTML = `
        <div class="part-input-section" data-part-index="${partCounter}">
            <div class="row">
                <div class="col-md-8">
                    <div class="upload-area part-upload-area" data-part-index="${partCounter}">
                        <i class="fas fa-shapes fa-2x text-primary mb-2"></i>
                        <p><strong>Part ${partCounter + 1}</strong></p>
                        <p class="text-muted small">Drop image or click to upload</p>
                        <input type="file" class="part-image-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity</label>
                    <input type="number" class="form-control part-quantity" min="1" value="1">
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2 remove-part-btn">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
            <div class="part-preview mt-2"></div>
        </div>
    `;
    
    partInputs.insertAdjacentHTML('beforeend', newPartHTML);
    initializePartUploadArea(partCounter);
    
    // Show remove buttons when there are multiple parts
    document.querySelectorAll('.remove-part-btn').forEach(btn => {
        btn.style.display = 'block';
    });
}

function updateAnalyzeButton() {
    const sheetImage = document.getElementById('sheetImageInput').files[0];
    const partImages = document.querySelectorAll('.part-image-input');
    
    let hasPartImages = false;
    partImages.forEach(input => {
        if (input.files[0]) hasPartImages = true;
    });
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    analyzeBtn.disabled = !sheetImage || !hasPartImages;
    
    // Hide loading spinner if button is disabled
    if (analyzeBtn.disabled) {
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
            loadingSpinner.style.visibility = 'hidden';
            loadingSpinner.style.opacity = '0';
        }
    }
}

function analyzeNesting() {
    const formData = new FormData();
    
    // Add sheet image
    const sheetImage = document.getElementById('sheetImageInput').files[0];
    if (!sheetImage) {
        showError('Please upload a sheet image first');
        return;
    }
    formData.append('sheet_image', sheetImage);
    
    // Add part images and quantities
    const partSections = document.querySelectorAll('.part-input-section');
    let hasValidParts = false;
    
    partSections.forEach((section, index) => {
        const imageInput = section.querySelector('.part-image-input');
        const quantityInput = section.querySelector('.part-quantity');
        
        if (imageInput.files[0]) {
            formData.append('part_images', imageInput.files[0]);
            formData.append(`quantity_${index}`, quantityInput.value);
            hasValidParts = true;
        }
    });
    
    if (!hasValidParts) {
        showError('Please upload at least one part image');
        return;
    }
    
    // Show loading
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
        loadingSpinner.style.visibility = 'visible';
        loadingSpinner.style.opacity = '1';
    }
    document.getElementById('analyzeBtn').disabled = true;
    hideError();
    
    // Send request
    fetch('/packing/api/analyze-nesting', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
            loadingSpinner.style.visibility = 'hidden';
            loadingSpinner.style.opacity = '0';
        }
        document.getElementById('analyzeBtn').disabled = false;
        
        if (data.success) {
            displayResults(data);
        } else {
            showError(data.error || 'Analysis failed');
        }
    })
    .catch(error => {
        const loadingSpinner = document.getElementById('loadingSpinner');
        if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
            loadingSpinner.style.visibility = 'hidden';
            loadingSpinner.style.opacity = '0';
        }
        document.getElementById('analyzeBtn').disabled = false;
        showError('Network error: ' + error.message);
    });
}

function displayResults(data) {
    const summary = data.summary;
    
    // Display summary metrics
    const summaryHTML = `
        <div class="col-md-3">
            <div class="text-center p-3 border rounded">
                <div class="efficiency-metric text-success">${summary.parts_placed}</div>
                <p class="text-muted mb-0">Parts Placed</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded">
                <div class="efficiency-metric text-primary">${summary.efficiency}%</div>
                <p class="text-muted mb-0">Efficiency</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded">
                <div class="efficiency-metric text-warning">${summary.scrap_percent}%</div>
                <p class="text-muted mb-0">Scrap</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="text-center p-3 border rounded">
                <div class="efficiency-metric text-info">${summary.total_scrap_area}</div>
                <p class="text-muted mb-0">Scrap Area</p>
            </div>
        </div>
    `;
    
    document.getElementById('resultsSummary').innerHTML = summaryHTML;
    
    // Display SVG layout
    if (data.svg_layout) {
        document.getElementById('svgLayoutContainer').innerHTML = data.svg_layout;
    }
    
    // Display efficiency chart
    displayEfficiencyChart(data.chart_data);
    
    // Show results
    document.querySelector('.result-card').style.display = 'block';
    
    // Scroll to results
    document.querySelector('.result-card').scrollIntoView({ behavior: 'smooth' });
}

function displayEfficiencyChart(chartData) {
    const ctx = document.getElementById('efficiencyChart').getContext('2d');
    
    if (efficiencyChart) {
        efficiencyChart.destroy();
    }
    
    efficiencyChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.data,
                backgroundColor: chartData.colors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Display efficiency metrics
    const metricsHTML = `
        <div class="row">
            <div class="col-6">
                <strong>Parts Fit:</strong><br>
                <span class="text-success">${chartData.successful_parts}/${chartData.total_requested}</span>
            </div>
            <div class="col-6">
                <strong>Efficiency:</strong><br>
                <span class="text-primary">${chartData.efficiency_percent.toFixed(1)}%</span>
            </div>
        </div>
    `;
    
    document.getElementById('efficiencyMetrics').innerHTML = metricsHTML;
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
}

function hideError() {
    document.getElementById('errorAlert').style.display = 'none';
}
</script>
{% endblock %}