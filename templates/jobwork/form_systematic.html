{% extends "base.html" %}

{% block title %}{{ title }} - Factory Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-tools text-primary"></i> {{ title }}</h1>
            <p class="text-muted">Systematic job work creation with intelligent workflow management</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{{ url_for('jobwork.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('jobwork.list_job_works') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i> All Jobs
                </a>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-icon"><i class="fas fa-info-circle"></i></div>
                    <div class="step-title">Basic Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-icon"><i class="fas fa-box"></i></div>
                    <div class="step-title">Materials</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-icon"><i class="fas fa-cogs"></i></div>
                    <div class="step-title">Process</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="step-title">Costing</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-icon"><i class="fas fa-check"></i></div>
                    <div class="step-title">Review</div>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="jobWorkForm" novalidate>
        {{ form.hidden_tag() }}

        <!-- Step 1: Basic Information -->
        <div class="form-step active" data-step="1">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Step 1: Basic Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Job Work Type Selection -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Job Work Type</label>
                            <div class="job-type-selector">
                                <div class="form-check form-check-card">
                                    <input class="form-check-input" type="radio" name="job_work_type" id="type_bom" value="bom">
                                    <label class="form-check-label" for="type_bom">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-sitemap fa-2x text-primary mb-2"></i>
                                                <h6>BOM-Based</h6>
                                                <small class="text-muted">Use existing Bill of Materials</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check form-check-card">
                                    <input class="form-check-input" type="radio" name="job_work_type" id="type_manual" value="manual">
                                    <label class="form-check-label" for="type_manual">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="fas fa-edit fa-2x text-success mb-2"></i>
                                                <h6>Manual Entry</h6>
                                                <small class="text-muted">Create custom job work</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- BOM Selection (shown when BOM-based is selected) -->
                        <div class="col-md-6 mb-3" id="bomSelection" style="display: none;">
                            <label for="bom_id" class="form-label required">Select BOM</label>
                            {{ form.bom_id(class="form-select", id="bom_id") }}
                            <div class="form-text">Choose the Bill of Materials to use for this job work</div>
                        </div>

                        <!-- Work Type -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required">Execution Type</label>
                            <div class="work-type-selector">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="work_type" id="work_in_house" value="in_house">
                                    <label class="form-check-label" for="work_in_house">
                                        <i class="fas fa-home text-info"></i> In-House
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="work_type" id="work_outsourced" value="outsourced">
                                    <label class="form-check-label" for="work_outsourced">
                                        <i class="fas fa-external-link-alt text-warning"></i> Outsourced
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Assignment -->
                        <div class="col-md-6 mb-3">
                            <label for="assigned_to" class="form-label required">Assigned To</label>
                            {{ form.assigned_to(class="form-select", id="assigned_to") }}
                            <div class="form-text" id="assignmentHelp">Select department or vendor based on execution type</div>
                        </div>

                        <!-- Job Title -->
                        <div class="col-12 mb-3">
                            <label for="job_title" class="form-label required">Job Title</label>
                            {{ form.job_title(class="form-control", id="job_title", placeholder="Enter descriptive job title or let system auto-generate") }}
                            <div class="form-text">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="autoGenerateTitle">
                                    <i class="fas fa-magic"></i> Auto-Generate Title
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                            Next: Materials <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Materials & Quantities -->
        <div class="form-step" data-step="2">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        Step 2: Materials & Quantities
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Input Material Selection -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="input_material_id" class="form-label required">Input Material</label>
                            {{ form.input_material_id(class="form-select", id="input_material_id") }}
                            <div class="form-text">Select the raw material or component to be processed</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="quantity_to_issue" class="form-label required">Quantity to Issue</label>
                            <div class="input-group">
                                {{ form.quantity_to_issue(class="form-control", id="quantity_to_issue") }}
                                <span class="input-group-text" id="inputUnitDisplay">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Tracking -->
                    <div class="row" id="batchTrackingSection">
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableBatchTracking" checked>
                                <label class="form-check-label" for="enableBatchTracking">
                                    Enable Batch Tracking
                                </label>
                            </div>
                        </div>
                        <div class="col-12" id="batchSelectionArea">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="batchTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Select</th>
                                            <th>Batch Number</th>
                                            <th>Available Qty</th>
                                            <th>Use Qty</th>
                                            <th>Manufacturing Date</th>
                                            <th>Quality Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Batch rows will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Output Product Selection -->
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="output_product_id" class="form-label">Expected Output Product</label>
                            <select class="form-select" id="output_product_id" name="output_product_id">
                                <option value="">Select Output Product (Optional)</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <div class="form-text">Select what will be produced (optional for service work)</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="expected_output_quantity" class="form-label">Expected Output Qty</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="expected_output_quantity" name="expected_output_quantity" step="0.01" min="0">
                                <span class="input-group-text" id="outputUnitDisplay">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(1)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                            Next: Process <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Process & Timeline -->
        <div class="form-step" data-step="3">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Step 3: Process & Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Process Selection -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Process Type</label>
                            <div class="form-check form-check-card">
                                <input class="form-check-input" type="radio" name="process_type" id="single_process" value="single" checked>
                                <label class="form-check-label" for="single_process">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-arrow-right fa-2x text-primary mb-2"></i>
                                            <h6>Single Process</h6>
                                            <small class="text-muted">One vendor, one process</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check form-check-card">
                                <input class="form-check-input" type="radio" name="process_type" id="multi_process" value="multi">
                                <label class="form-check-label" for="multi_process">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-project-diagram fa-2x text-info mb-2"></i>
                                            <h6>Multi-Process</h6>
                                            <small class="text-muted">Multiple vendors/stages</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="col-md-6">
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label for="send_date" class="form-label">Send Date</label>
                                    {{ form.send_date(class="form-control", id="send_date") }}
                                </div>
                                <div class="col-6 mb-3">
                                    <label for="expected_return" class="form-label">Expected Return</label>
                                    {{ form.expected_return(class="form-control", id="expected_return") }}
                                </div>
                            </div>
                        </div>

                        <!-- Process Details -->
                        <div class="col-12">
                            <!-- Single Process Form -->
                            <div id="singleProcessForm">
                                <div class="row">
                                    <div class="col-md-8 mb-3">
                                        <label for="process_names" class="form-label required">Process Description</label>
                                        <input type="text" class="form-control" id="process_names" name="process_names" placeholder="e.g., Laser cutting, welding, powder coating">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label for="rate_per_unit" class="form-label">Rate per Unit</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="number" class="form-control" id="rate_per_unit" name="rate_per_unit" step="0.01" min="0">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Multi Process Form (initially hidden) -->
                            <div id="multiProcessForm" style="display: none;">
                                <div class="process-workflow">
                                    <h6><i class="fas fa-route"></i> Process Workflow</h6>
                                    <div id="processSteps">
                                        <!-- Process steps will be added dynamically -->
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addProcessStep()">
                                        <i class="fas fa-plus"></i> Add Process Step
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Special Instructions -->
                        <div class="col-12 mb-3">
                            <label for="remarks" class="form-label">Special Instructions</label>
                            {{ form.remarks(class="form-control", id="remarks", rows="3", placeholder="Any special requirements, quality standards, or handling instructions") }}
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(2)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(4)">
                            Next: Costing <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Costing & Terms -->
        <div class="form-step" data-step="4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Step 4: Costing & Terms
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Cost Summary -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="table-responsive">
                                <table class="table table-sm" id="costBreakdown">
                                    <thead>
                                        <tr>
                                            <th>Cost Component</th>
                                            <th class="text-end">Amount (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Material Cost</td>
                                            <td class="text-end" id="materialCost">0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Process Cost</td>
                                            <td class="text-end" id="processCost">0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Transportation</td>
                                            <td class="text-end">
                                                <input type="number" class="form-control form-control-sm text-end" id="transportationCost" value="0">
                                            </td>
                                        </tr>
                                        <tr class="table-primary">
                                            <th>Total Estimated Cost</th>
                                            <th class="text-end" id="totalCost">0.00</th>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Payment Terms -->
                            <div class="card border-light">
                                <div class="card-header">
                                    <h6 class="mb-0">Payment Terms</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <label class="form-label">Payment Method</label>
                                        <select class="form-select form-select-sm">
                                            <option>On Completion</option>
                                            <option>50% Advance</option>
                                            <option>30 Days Credit</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Quality Terms</label>
                                        <select class="form-select form-select-sm">
                                            <option>Standard Quality</option>
                                            <option>100% Inspection</option>
                                            <option>Sample Approval</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(3)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(5)">
                            Next: Review <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Review & Submit -->
        <div class="form-step" data-step="5">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check me-2"></i>
                        Step 5: Review & Submit
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Summary -->
                    <div id="jobSummary">
                        <!-- Summary will be populated by JavaScript -->
                    </div>

                    <!-- Validation Results -->
                    <div id="validationResults" class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Click "Validate" to check for any issues before submitting.
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="previousStep(4)">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="validateForm()">
                                <i class="fas fa-check-circle"></i> Validate
                            </button>
                            <button type="button" class="btn btn-outline-primary me-2" onclick="saveDraft()">
                                <i class="fas fa-save"></i> Save Draft
                            </button>
                            <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                                <i class="fas fa-paper-plane"></i> Submit Job Work
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Job Work Form Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="accordion" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                Step 1: Basic Information
                            </button>
                        </h2>
                        <div id="help1" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <p><strong>BOM-Based:</strong> Use this when you have a predefined Bill of Materials. The system will automatically populate material requirements.</p>
                                <p><strong>Manual Entry:</strong> Use for custom or one-off job works where you need to specify materials manually.</p>
                                <p><strong>In-House vs Outsourced:</strong> In-house work goes to departments, outsourced work goes to external vendors.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Add more help sections as needed -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Progress Steps Styling */
.progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 10px;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    position: relative;
}

.step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    right: -50%;
    width: 100%;
    height: 2px;
    background: #dee2e6;
    z-index: -1;
}

.step.active::after,
.step.completed::after {
    background: #0d6efd;
}

.step-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.5rem;
    color: #6c757d;
}

.step.active .step-icon {
    background: #0d6efd;
    color: white;
}

.step.completed .step-icon {
    background: #198754;
    color: white;
}

.step-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
}

.step.active .step-title {
    color: #0d6efd;
    font-weight: 600;
}

/* Form Step Styling */
.form-step {
    display: none;
}

.form-step.active {
    display: block;
}

/* Job Type Selector */
.job-type-selector {
    display: flex;
    gap: 1rem;
}

.form-check-card {
    flex: 1;
}

.form-check-card .form-check-input {
    display: none;
}

.form-check-card .card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid #e9ecef;
}

.form-check-card .form-check-input:checked + .form-check-label .card {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Work Type Selector */
.work-type-selector .form-check-label {
    cursor: pointer;
    padding: 0.5rem 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
    display: inline-block;
    margin-right: 0.5rem;
}

.work-type-selector .form-check-input:checked + .form-check-label {
    background-color: #e7f3ff;
    border-color: #0d6efd;
    color: #0d6efd;
}

/* Process Workflow */
.process-workflow {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background: #f8f9fa;
}

.process-step {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
    position: relative;
}

.process-step .step-number {
    position: absolute;
    top: -10px;
    left: 10px;
    background: #0d6efd;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
}

/* Batch Table */
#batchTable tbody tr {
    cursor: pointer;
}

#batchTable tbody tr:hover {
    background-color: #f8f9fa;
}

#batchTable tbody tr.selected {
    background-color: #e7f3ff;
}

/* Cost Breakdown */
#costBreakdown input {
    border: none;
    background: transparent;
}

#costBreakdown input:focus {
    border: 1px solid #0d6efd;
    background: white;
}

/* Required Field Indicator */
.required::after {
    content: " *";
    color: #dc3545;
}

/* Animation for step transitions */
.form-step {
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .progress-steps {
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .step {
        min-width: 80px;
    }
    
    .step::after {
        display: none;
    }
    
    .job-type-selector,
    .work-type-selector {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>

<script>
// Form management variables
let currentStep = 1;
let formData = {};
let processStepCounter = 0;

// Initialize form on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupEventListeners();
    loadFormData();
});

function initializeForm() {
    // Set current date as default send date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('send_date').value = today;
    
    // Set expected return date (7 days from now)
    const expectedDate = new Date();
    expectedDate.setDate(expectedDate.getDate() + 7);
    document.getElementById('expected_return').value = expectedDate.toISOString().split('T')[0];
    
    // Initialize step 1 as active
    showStep(1);
}

function setupEventListeners() {
    // Job work type change
    document.querySelectorAll('input[name="job_work_type"]').forEach(radio => {
        radio.addEventListener('change', handleJobWorkTypeChange);
    });
    
    // Work type change
    document.querySelectorAll('input[name="work_type"]').forEach(radio => {
        radio.addEventListener('change', handleWorkTypeChange);
    });
    
    // Process type change
    document.querySelectorAll('input[name="process_type"]').forEach(radio => {
        radio.addEventListener('change', handleProcessTypeChange);
    });
    
    // Input material change
    document.getElementById('input_material_id').addEventListener('change', handleInputMaterialChange);
    
    // BOM selection change
    document.getElementById('bom_id').addEventListener('change', handleBOMChange);
    
    // Auto-generate title button
    document.getElementById('autoGenerateTitle').addEventListener('click', autoGenerateJobTitle);
    
    // Form submission
    document.getElementById('jobWorkForm').addEventListener('submit', handleFormSubmit);
    
    // Real-time cost calculation
    document.getElementById('rate_per_unit').addEventListener('input', calculateCosts);
    document.getElementById('quantity_sent').addEventListener('input', calculateCosts);
    document.getElementById('transportationCost').addEventListener('input', calculateCosts);
}

function handleJobWorkTypeChange(event) {
    const jobWorkType = event.target.value;
    const bomSelection = document.getElementById('bomSelection');
    
    if (jobWorkType === 'bom') {
        bomSelection.style.display = 'block';
        bomSelection.querySelector('select').required = true;
    } else {
        bomSelection.style.display = 'none';
        bomSelection.querySelector('select').required = false;
        // Auto-generate title for manual jobs
        autoGenerateJobTitle();
    }
}

function handleWorkTypeChange(event) {
    const workType = event.target.value;
    const assignedToSelect = document.getElementById('assigned_to');
    const helpText = document.getElementById('assignmentHelp');
    
    // Update assigned_to options based on work type
    if (workType === 'in_house') {
        helpText.textContent = 'Select the department that will handle this work';
        // Load departments
        loadDepartments();
    } else {
        helpText.textContent = 'Select the vendor that will handle this work';
        // Load vendors
        loadVendors();
    }
}

function handleProcessTypeChange(event) {
    const processType = event.target.value;
    const singleForm = document.getElementById('singleProcessForm');
    const multiForm = document.getElementById('multiProcessForm');
    
    if (processType === 'single') {
        singleForm.style.display = 'block';
        multiForm.style.display = 'none';
    } else {
        singleForm.style.display = 'none';
        multiForm.style.display = 'block';
        // Initialize with one process step
        if (document.getElementById('processSteps').children.length === 0) {
            addProcessStep();
        }
    }
}

function handleInputMaterialChange(event) {
    const itemId = event.target.value;
    if (itemId && itemId !== '0') {
        // Load item details
        loadItemDetails(itemId);
        // Load available batches if batch tracking is enabled
        if (document.getElementById('enableBatchTracking').checked) {
            loadAvailableBatches(itemId);
        }
    }
}

function handleBOMChange(event) {
    const bomId = event.target.value;
    if (bomId && bomId !== '0') {
        loadBOMDetails(bomId);
    }
}

function loadItemDetails(itemId) {
    fetch(`/jobwork/api/systematic/items/${itemId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update unit displays
                document.getElementById('inputUnitDisplay').textContent = data.unit_of_measure || '-';
                // Auto-fill output product if it's a processing job
                if (data.processed_form) {
                    document.getElementById('output_product_id').value = data.processed_form;
                }
            }
        })
        .catch(error => console.error('Error loading item details:', error));
}

function loadBOMDetails(bomId) {
    fetch(`/jobwork/api/bom/${bomId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Auto-fill form with BOM data
                document.getElementById('job_title').value = `BOM Job: ${data.bom_code} - ${data.product_name}`;
                if (data.input_materials.length > 0) {
                    document.getElementById('input_material_id').value = data.input_materials[0].id;
                    handleInputMaterialChange({target: {value: data.input_materials[0].id}});
                }
                document.getElementById('output_product_id').value = data.product_id;
                document.getElementById('expected_output_quantity').value = data.output_quantity || 1;
                
                // Load process information if available
                if (data.processes && data.processes.length > 0) {
                    const processNames = data.processes.map(p => p.name).join(', ');
                    document.getElementById('process_names').value = processNames;
                }
            }
        })
        .catch(error => console.error('Error loading BOM details:', error));
}

function loadAvailableBatches(itemId) {
    fetch(`/jobwork/api/systematic/items/${itemId}/batches`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateBatchTable(data.batches);
            }
        })
        .catch(error => console.error('Error loading batches:', error));
}

function populateBatchTable(batches) {
    const tbody = document.querySelector('#batchTable tbody');
    tbody.innerHTML = '';
    
    batches.forEach(batch => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <input type="checkbox" class="form-check-input batch-select" 
                       value="${batch.id}" data-available="${batch.available_quantity}">
            </td>
            <td>${batch.batch_number}</td>
            <td>${batch.available_quantity} ${batch.unit}</td>
            <td>
                <input type="number" class="form-control form-control-sm batch-quantity" 
                       min="0" max="${batch.available_quantity}" step="0.01">
            </td>
            <td>${batch.manufacture_date || '-'}</td>
            <td><span class="badge bg-${batch.quality_status === 'good' ? 'success' : 'warning'}">${batch.quality_status}</span></td>
        `;
        tbody.appendChild(row);
    });
    
    // Add event listeners for batch selection
    tbody.querySelectorAll('.batch-select').forEach(checkbox => {
        checkbox.addEventListener('change', handleBatchSelection);
    });
}

function handleBatchSelection(event) {
    const row = event.target.closest('tr');
    const quantityInput = row.querySelector('.batch-quantity');
    
    if (event.target.checked) {
        row.classList.add('selected');
        quantityInput.required = true;
        // Auto-fill with available quantity
        quantityInput.value = event.target.dataset.available;
    } else {
        row.classList.remove('selected');
        quantityInput.required = false;
        quantityInput.value = '';
    }
    
    updateTotalSelectedQuantity();
}

function updateTotalSelectedQuantity() {
    let total = 0;
    document.querySelectorAll('.batch-select:checked').forEach(checkbox => {
        const row = checkbox.closest('tr');
        const quantity = parseFloat(row.querySelector('.batch-quantity').value) || 0;
        total += quantity;
    });
    
    // Update the main quantity to issue field
    document.getElementById('quantity_to_issue').value = total;
    calculateCosts();
}

function autoGenerateJobTitle() {
    const jobWorkType = document.querySelector('input[name="job_work_type"]:checked')?.value;
    const workType = document.querySelector('input[name="work_type"]:checked')?.value;
    const inputMaterial = document.getElementById('input_material_id').selectedOptions[0]?.text;
    
    let title = 'JW-';
    
    // Add sequential number (this should come from backend in real implementation)
    const jobNumber = String(Date.now()).slice(-4);
    title += jobNumber;
    
    if (inputMaterial && inputMaterial !== 'Select Input Material') {
        title += ` - ${inputMaterial.split(' - ')[1] || inputMaterial}`;
    }
    
    if (workType === 'in_house') {
        title += ' (In-House)';
    }
    
    document.getElementById('job_title').value = title;
}

function addProcessStep() {
    processStepCounter++;
    const processSteps = document.getElementById('processSteps');
    
    const stepDiv = document.createElement('div');
    stepDiv.className = 'process-step';
    stepDiv.innerHTML = `
        <div class="step-number">${processStepCounter}</div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label class="form-label">Process Name</label>
                <input type="text" class="form-control" name="process_step_${processStepCounter}_name" 
                       placeholder="e.g., Cutting, Welding, Assembly" required>
            </div>
            <div class="col-md-4 mb-2">
                <label class="form-label">Vendor</label>
                <select class="form-select" name="process_step_${processStepCounter}_vendor">
                    <option value="">Select Vendor</option>
                    <!-- Vendor options will be populated -->
                </select>
            </div>
            <div class="col-md-2 mb-2">
                <label class="form-label">Rate (₹)</label>
                <input type="number" class="form-control" name="process_step_${processStepCounter}_rate" 
                       step="0.01" min="0" onchange="calculateCosts()">
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <label class="form-label">Process Description</label>
                <textarea class="form-control" name="process_step_${processStepCounter}_description" rows="2"
                         placeholder="Detailed process instructions and quality requirements"></textarea>
            </div>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removeProcessStep(this)">
            <i class="fas fa-trash"></i> Remove Step
        </button>
    `;
    
    processSteps.appendChild(stepDiv);
    loadVendorsForStep(processStepCounter);
}

function removeProcessStep(button) {
    button.closest('.process-step').remove();
    // Renumber steps
    const steps = document.querySelectorAll('.process-step');
    steps.forEach((step, index) => {
        step.querySelector('.step-number').textContent = index + 1;
    });
    calculateCosts();
}

function loadDepartments() {
    fetch('/jobwork/api/departments')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('assigned_to');
            select.innerHTML = '<option value="">Select Department</option>';
            data.forEach(dept => {
                select.innerHTML += `<option value="dept_${dept.id}">${dept.name}</option>`;
            });
        })
        .catch(error => console.error('Error loading departments:', error));
}

function loadVendors() {
    fetch('/jobwork/api/suppliers?type=jobwork')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('assigned_to');
            select.innerHTML = '<option value="">Select Vendor</option>';
            data.forEach(vendor => {
                select.innerHTML += `<option value="vendor_${vendor.id}">${vendor.name}</option>`;
            });
        })
        .catch(error => console.error('Error loading vendors:', error));
}

function loadVendorsForStep(stepNumber) {
    fetch('/jobwork/api/suppliers?type=jobwork')
        .then(response => response.json())
        .then(data => {
            const select = document.querySelector(`select[name="process_step_${stepNumber}_vendor"]`);
            if (select) {
                data.forEach(vendor => {
                    select.innerHTML += `<option value="${vendor.id}">${vendor.name}</option>`;
                });
            }
        })
        .catch(error => console.error('Error loading vendors for step:', error));
}

function calculateCosts() {
    const quantity = parseFloat(document.getElementById('quantity_to_issue').value) || 0;
    const ratePerUnit = parseFloat(document.getElementById('rate_per_unit').value) || 0;
    const transportCost = parseFloat(document.getElementById('transportationCost').value) || 0;
    
    let processCost = 0;
    
    // Calculate process cost based on current process type
    const processType = document.querySelector('input[name="process_type"]:checked')?.value;
    if (processType === 'single') {
        processCost = quantity * ratePerUnit;
    } else {
        // Calculate multi-process costs
        document.querySelectorAll('.process-step').forEach((step, index) => {
            const stepRate = parseFloat(step.querySelector(`input[name*="_rate"]`)?.value) || 0;
            processCost += quantity * stepRate;
        });
    }
    
    const materialCost = 0; // This would come from material pricing
    const totalCost = materialCost + processCost + transportCost;
    
    // Update cost display
    document.getElementById('materialCost').textContent = materialCost.toFixed(2);
    document.getElementById('processCost').textContent = processCost.toFixed(2);
    document.getElementById('totalCost').textContent = totalCost.toFixed(2);
}

function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
    });
    
    // Show current step
    document.querySelector(`.form-step[data-step="${stepNumber}"]`).classList.add('active');
    
    // Update progress indicators
    document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
        const stepNum = parseInt(step.dataset.step);
        if (stepNum === stepNumber) {
            step.classList.add('active');
        } else if (stepNum < stepNumber) {
            step.classList.add('completed');
        }
    });
    
    currentStep = stepNumber;
    
    // Update form summary if on review step
    if (stepNumber === 5) {
        generateSummary();
    }
}

function nextStep(stepNumber) {
    if (validateCurrentStep()) {
        showStep(stepNumber);
    }
}

function previousStep(stepNumber) {
    showStep(stepNumber);
}

function validateCurrentStep() {
    const currentStepElement = document.querySelector('.form-step.active');
    const requiredFields = currentStepElement.querySelectorAll('input[required], select[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    // Custom validations based on current step
    if (currentStep === 1) {
        // Validate job work type selection
        const jobWorkType = document.querySelector('input[name="job_work_type"]:checked');
        if (!jobWorkType) {
            alert('Please select a job work type (BOM-Based or Manual)');
            isValid = false;
        }
        
        const workType = document.querySelector('input[name="work_type"]:checked');
        if (!workType) {
            alert('Please select work type (In-House or Outsourced)');
            isValid = false;
        }
    } else if (currentStep === 2) {
        // Validate material and quantity
        const inputMaterial = document.getElementById('input_material_id').value;
        const quantity = document.getElementById('quantity_to_issue').value;
        
        if (!inputMaterial || inputMaterial === '0') {
            alert('Please select an input material');
            isValid = false;
        }
        
        if (!quantity || parseFloat(quantity) <= 0) {
            alert('Please enter a valid quantity');
            isValid = false;
        }
        
        // If batch tracking is enabled, validate batch selection
        if (document.getElementById('enableBatchTracking').checked) {
            const selectedBatches = document.querySelectorAll('.batch-select:checked');
            if (selectedBatches.length === 0) {
                alert('Please select at least one batch');
                isValid = false;
            }
        }
    }
    
    if (!isValid) {
        currentStepElement.classList.add('shake');
        setTimeout(() => {
            currentStepElement.classList.remove('shake');
        }, 500);
    }
    
    return isValid;
}

function generateSummary() {
    const summary = document.getElementById('jobSummary');
    
    // Collect form data
    const jobWorkType = document.querySelector('input[name="job_work_type"]:checked')?.value || 'Not selected';
    const workType = document.querySelector('input[name="work_type"]:checked')?.value || 'Not selected';
    const jobTitle = document.getElementById('job_title').value || 'Not specified';
    const inputMaterial = document.getElementById('input_material_id').selectedOptions[0]?.text || 'Not selected';
    const quantity = document.getElementById('quantity_sent').value || '0';
    const processType = document.querySelector('input[name="process_type"]:checked')?.value || 'single';
    
    summary.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Job Work Details</h6>
                <table class="table table-sm">
                    <tr><td><strong>Type:</strong></td><td>${jobWorkType}</td></tr>
                    <tr><td><strong>Execution:</strong></td><td>${workType}</td></tr>
                    <tr><td><strong>Title:</strong></td><td>${jobTitle}</td></tr>
                    <tr><td><strong>Process Type:</strong></td><td>${processType}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Material & Quantity</h6>
                <table class="table table-sm">
                    <tr><td><strong>Input Material:</strong></td><td>${inputMaterial}</td></tr>
                    <tr><td><strong>Quantity:</strong></td><td>${quantity}</td></tr>
                    <tr><td><strong>Estimated Cost:</strong></td><td>₹${document.getElementById('totalCost').textContent}</td></tr>
                </table>
            </div>
        </div>
    `;
}

function validateForm() {
    const validationResults = document.getElementById('validationResults');
    const submitBtn = document.getElementById('submitBtn');
    
    // Perform comprehensive validation
    let errors = [];
    let warnings = [];
    
    // Basic validation
    if (!document.querySelector('input[name="job_work_type"]:checked')) {
        errors.push('Job work type not selected');
    }
    
    if (!document.querySelector('input[name="work_type"]:checked')) {
        errors.push('Work type not selected');
    }
    
    if (!document.getElementById('job_title').value.trim()) {
        errors.push('Job title is required');
    }
    
    if (!document.getElementById('input_material_id').value || document.getElementById('input_material_id').value === '0') {
        errors.push('Input material not selected');
    }
    
    const quantity = parseFloat(document.getElementById('quantity_sent').value);
    if (!quantity || quantity <= 0) {
        errors.push('Valid quantity is required');
    }
    
    // Business logic validation
    if (document.getElementById('enableBatchTracking').checked) {
        const selectedBatches = document.querySelectorAll('.batch-select:checked');
        if (selectedBatches.length === 0) {
            warnings.push('Batch tracking is enabled but no batches selected');
        }
    }
    
    const totalCost = parseFloat(document.getElementById('totalCost').textContent);
    if (totalCost === 0) {
        warnings.push('Total cost is zero - please verify rates');
    }
    
    // Display results
    let resultHTML = '';
    if (errors.length > 0) {
        resultHTML += `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-circle"></i> Errors Found:</h6>
                <ul class="mb-0">
                    ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            </div>
        `;
        submitBtn.disabled = true;
    } else if (warnings.length > 0) {
        resultHTML += `
            <div class="alert alert-warning">
                <h6><i class="fas fa-exclamation-triangle"></i> Warnings:</h6>
                <ul class="mb-0">
                    ${warnings.map(warning => `<li>${warning}</li>`).join('')}
                </ul>
            </div>
        `;
        submitBtn.disabled = false;
    } else {
        resultHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> Validation successful! Form is ready for submission.
            </div>
        `;
        submitBtn.disabled = false;
    }
    
    validationResults.innerHTML = resultHTML;
}

function saveDraft() {
    // Collect all form data
    const formData = new FormData(document.getElementById('jobWorkForm'));
    
    // Add additional data
    formData.append('action', 'save_draft');
    
    fetch('/jobwork/save-draft', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Draft saved successfully!');
        } else {
            alert('Error saving draft: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        alert('Error saving draft');
    });
}

function loadFormData() {
    // Load saved draft if available
    const urlParams = new URLSearchParams(window.location.search);
    const draftId = urlParams.get('draft');
    
    if (draftId) {
        fetch(`/jobwork/load-draft/${draftId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Populate form with draft data
                    Object.keys(data.formData).forEach(key => {
                        const field = document.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (field.type === 'radio' || field.type === 'checkbox') {
                                if (field.value === data.formData[key]) {
                                    field.checked = true;
                                    field.dispatchEvent(new Event('change'));
                                }
                            } else {
                                field.value = data.formData[key];
                                field.dispatchEvent(new Event('change'));
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error loading draft:', error));
    }
}

function handleFormSubmit(event) {
    event.preventDefault();
    
    // Final validation
    if (!validateForm()) {
        alert('Please fix all errors before submitting');
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Job Work...';
    submitBtn.disabled = true;
    
    // Submit form
    const formData = new FormData(event.target);
    
    // Add batch selection data if enabled
    if (document.getElementById('enableBatchTracking').checked) {
        const selectedBatches = [];
        document.querySelectorAll('.batch-select:checked').forEach(checkbox => {
            const row = checkbox.closest('tr');
            const quantity = parseFloat(row.querySelector('.batch-quantity').value);
            selectedBatches.push({
                batch_id: checkbox.value,
                quantity: quantity
            });
        });
        formData.append('selected_batches', JSON.stringify(selectedBatches));
    }
    
    // Add process steps data for multi-process jobs
    if (document.querySelector('input[name="process_type"]:checked')?.value === 'multi') {
        const processSteps = [];
        document.querySelectorAll('.process-step').forEach((step, index) => {
            const stepNumber = index + 1;
            processSteps.push({
                step_number: stepNumber,
                process_name: step.querySelector(`input[name*="_name"]`).value,
                vendor_id: step.querySelector(`select[name*="_vendor"]`).value,
                rate: parseFloat(step.querySelector(`input[name*="_rate"]`).value) || 0,
                description: step.querySelector(`textarea[name*="_description"]`).value
            });
        });
        formData.append('process_steps', JSON.stringify(processSteps));
    }
    
    fetch('/jobwork/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Job Work created successfully!');
            window.location.href = '/jobwork/dashboard';
        } else {
            alert('Error creating job work: ' + data.message);
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
        alert('Error submitting form');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Add shake animation for validation errors
const style = document.createElement('style');
style.textContent = `
    .shake {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}