{% extends "base.html" %}

{% block title %}{{ title }} - Factory Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-tools text-primary"></i> {{ title }}</h1>
            <p class="text-muted">Complete job work creation form with all details on one page</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{{ url_for('jobwork.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('jobwork.list_job_works') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i> All Jobs
                </a>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#helpModal">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </div>
        </div>
    </div>

    <!-- Production Context Banner -->
    {% if production_context and production_context.production_number %}
    <div class="row mb-3">
        <div class="col">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle"></i>
                <strong>Production Context:</strong> This job work is being created for Production Order: 
                <strong>{{ production_context.production_number }}</strong>
                {% if production_context.component_code %}
                    - Component: <strong>{{ production_context.component_code }}</strong>
                {% endif %}
                {% if production_context.quantity %}
                    - Suggested Quantity: <strong>{{ production_context.quantity }}</strong>
                {% endif %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="POST" id="jobWorkForm" novalidate>
        {{ form.hidden_tag() }}

        <!-- Section 1: Basic Info & Job Work Type -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #4285f4; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Basic Info & Job Work Type
                </h5>
                <small>Configure job work type, BOM selection, execution type, and assignment details</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Job Work Type Selection -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Job Work Type</label>
                        <div class="job-type-selector">
                            <div class="form-check form-check-card">
                                <input class="form-check-input" type="radio" name="job_work_type" id="type_bom" value="bom">
                                <label class="form-check-label" for="type_bom">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-sitemap fa-2x text-primary mb-2"></i>
                                            <h6>BOM-Based</h6>
                                            <small class="text-muted">Use existing Bill of Materials with multi-level explosion</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            <div class="form-check form-check-card">
                                <input class="form-check-input" type="radio" name="job_work_type" id="type_manual" value="manual" checked>
                                <label class="form-check-label" for="type_manual">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-edit fa-2x text-success mb-2"></i>
                                            <h6>Manual Entry</h6>
                                            <small class="text-muted">Create custom job work with partial processing support</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- BOM Selection (shown when BOM-based is selected) -->
                    <div class="col-md-6 mb-3" id="bomSelection" style="display: none;">
                        <label for="bom_id" class="form-label required">Select BOM</label>
                        {{ form.bom_id(class="form-select", id="bom_id") }}
                        <div class="form-text">Choose the Bill of Materials to use for this job work</div>
                    </div>

                    <!-- Work Type -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label required">Execution Type</label>
                        <div class="work-type-selector">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="work_type" id="work_in_house" value="in_house">
                                <label class="form-check-label" for="work_in_house">
                                    <i class="fas fa-home text-info"></i> In-House
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="work_type" id="work_outsourced" value="outsourced" checked>
                                <label class="form-check-label" for="work_outsourced">
                                    <i class="fas fa-external-link-alt text-warning"></i> Outsourced
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Assignment -->
                    <div class="col-md-6 mb-3">
                        <label for="assigned_to" class="form-label required">Assigned To</label>
                        {{ form.assigned_to(class="form-select", id="assigned_to") }}
                        <div class="form-text" id="assignmentHelpText">Options will change based on execution type: departments for in-house work, vendors for outsourced work.</div>
                    </div>

                    <!-- Job Title -->
                    <div class="col-md-8 mb-3">
                        <label for="job_title" class="form-label required">Job Title</label>
                        {{ form.job_title(class="form-control", id="job_title", placeholder="Enter descriptive job title or let system auto-generate") }}
                    </div>

                    <!-- Auto Generate Button -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-outline-secondary" id="autoGenerateTitle">
                                <i class="fas fa-magic"></i> Auto-Generate Title
                            </button>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="col-md-4 mb-3">
                        <label for="send_date" class="form-label required">Send Date</label>
                        {{ form.send_date(class="form-control", id="send_date") }}
                    </div>

                    <div class="col-md-4 mb-3">
                        <label for="expected_return" class="form-label">Expected Return Date</label>
                        {{ form.expected_return(class="form-control", id="expected_return") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Input Materials & Quantities Details -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #34a853; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-box me-2"></i>
                    Input Materials & Quantities Details
                </h5>
                <small>Select input materials, enable batch tracking, and manage issuance quantities</small>
            </div>
            <div class="card-body">
                <!-- BOM-Based Materials (Auto-populated) -->
                <div id="bomMaterialsSection" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Materials are automatically loaded from the selected BOM with phantom BOM support and multi-level explosion
                    </div>
                    <div id="bomMaterialsList">
                        <!-- BOM materials will be populated here -->
                    </div>
                </div>

                <!-- Manual Material Selection -->
                <div id="manualMaterialsSection">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="input_material_id" class="form-label required">Input Material</label>
                            {{ form.input_material_id(class="form-select", id="input_material_id") }}
                            <div class="form-text">Select the raw material or component to be processed</div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="quantity_to_issue" class="form-label required">Quantity to Issue</label>
                            <div class="input-group">
                                {{ form.quantity_to_issue(class="form-control", id="quantity_to_issue") }}
                                <span class="input-group-text" id="inputUnitDisplay">Pcs</span>
                            </div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="input_uom" class="form-label">Unit of Measure</label>
                            {{ form.input_uom(class="form-select", id="input_uom") }}
                        </div>
                    </div>

                    <!-- Batch Tracking -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="enableBatchTracking" checked>
                                <label class="form-check-label" for="enableBatchTracking">
                                    <strong>Enable Batch Tracking</strong>
                                    <small class="text-muted d-block">Track materials using FIFO batch system with complete traceability</small>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3" id="batchSelectionSection">
                            <label for="batch_id" class="form-label">Select Batch</label>
                            {{ form.batch_id(class="form-select", id="batch_id") }}
                            <div class="form-text">Auto-selects FIFO batch or choose specific batch</div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Available Stock</label>
                            <div class="form-control-plaintext bg-light rounded px-2" id="availableStockDisplay">0.00</div>
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">Batch Available</label>
                            <div class="form-control-plaintext bg-light rounded px-2" id="batchAvailableDisplay">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Process Details -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #fbbc04; color: black;">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Process Details
                </h5>
                <small>Configure process workflow, routing, and multi-vendor sequential processing</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Process Type -->
                    <div class="col-md-4 mb-3">
                        <label for="process_type" class="form-label">Process Type</label>
                        {{ form.process_type(class="form-select", id="process_type") }}
                    </div>

                    <!-- Expected Output -->
                    <div class="col-md-4 mb-3">
                        <label for="expected_finished_material" class="form-label">Expected Output Quantity</label>
                        {{ form.expected_finished_material(class="form-control", id="expected_finished_material") }}
                    </div>

                    <!-- Expected Scrap -->
                    <div class="col-md-4 mb-3">
                        <label for="expected_scrap" class="form-label">Expected Scrap %</label>
                        <div class="input-group">
                            {{ form.expected_scrap(class="form-control", id="expected_scrap") }}
                            <span class="input-group-text">%</span>
                        </div>
                    </div>

                    <!-- Output Product -->
                    <div class="col-md-6 mb-3">
                        <label for="item_id" class="form-label">Output Product</label>
                        {{ form.item_id(class="form-select", id="item_id") }}
                        <div class="form-text">Select the expected output product from this job work</div>
                    </div>

                    <!-- Quality Requirements -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Quality Requirements</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="requiresInspection">
                            <label class="form-check-label" for="requiresInspection">
                                Requires Quality Inspection
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createOutputBatch" checked>
                            <label class="form-check-label" for="createOutputBatch">
                                Create Output Batch for Tracking
                            </label>
                        </div>
                    </div>

                    <!-- BOM Process Selection (dynamically populated) -->
                    <div class="col-12 mb-3" id="bomProcessSelection" style="display: none;">
                        <label class="form-label"><i class="fas fa-route"></i> Select Processes from BOM</label>
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <small class="text-muted">Choose which processes from the BOM to include in this job work</small>
                            </div>
                            <div class="card-body" id="bomProcessList">
                                <!-- Process checkboxes will be populated here by JavaScript -->
                            </div>
                        </div>
                        <input type="hidden" id="selectedProcesses" name="selected_processes" value="">
                    </div>

                    <!-- Dynamic Rate Fields (populated based on selected processes) -->
                    <div class="col-12 mb-3" id="processRatesSection" style="display: none;">
                        <label class="form-label"><i class="fas fa-money-bill-wave"></i> Process Rates</label>
                        <div class="card border-success">
                            <div class="card-header bg-light">
                                <small class="text-muted">Rates for selected processes (auto-populated from BOM)</small>
                            </div>
                            <div class="card-body" id="processRatesList">
                                <!-- Rate fields will be populated here by JavaScript -->
                            </div>
                        </div>
                        <input type="hidden" id="processRatesData" name="process_rates_data" value="">
                    </div>

                    <!-- Multi-Vendor Routing -->
                    <div class="col-12 mb-3">
                        <label class="form-label">Multi-Vendor Sequential Routing</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableMultiVendor">
                            <label class="form-check-label" for="enableMultiVendor">
                                Enable sequential processing through multiple vendors
                            </label>
                        </div>
                        <div id="multiVendorRouting" style="display: none;">
                            <div class="alert alert-info mt-2">
                                <i class="fas fa-info-circle"></i> Configure the sequence of vendors for this job work. Material will auto-forward between vendors.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 4: Costing Details -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #00acc1; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-dollar-sign me-2"></i>
                    Costing Details
                </h5>
<small>Configure payment terms, quality requirements, and additional costs (rates are handled in Process Details above)</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Payment Terms -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Payment Terms</label>
                        <select class="form-select" id="paymentTerms">
                            <option value="on_completion">On Completion</option>
                            <option value="advance_50">50% Advance</option>
                            <option value="credit_30">30 Days Credit</option>
                            <option value="advance_30_balance_completion">30% Advance, Balance on Completion</option>
                        </select>
                    </div>

                    <!-- Quality Terms -->
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Quality Terms</label>
                        <select class="form-select" id="qualityTerms">
                            <option value="standard">Standard Quality</option>
                            <option value="100_inspection">100% Inspection Required</option>
                            <option value="sample_approval">Sample Approval Required</option>
                            <option value="zero_defect">Zero Defect Policy</option>
                        </select>
                    </div>
                </div>

                <!-- Cost Breakdown Table -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Cost Estimation</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Cost Component</th>
                                        <th class="text-end">Amount (₹)</th>
                                        <th class="text-end">Per Unit (₹)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Process Cost (from BOM)</td>
                                        <td class="text-end" id="processCost">0.00</td>
                                        <td class="text-end" id="processCostPerUnit">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Transportation Cost</td>
                                        <td class="text-end">
                                            <input type="number" class="form-control form-control-sm text-end" id="transportationCost" value="0">
                                        </td>
                                        <td class="text-end" id="transportationCostPerUnit">0.00</td>
                                    </tr>
                                    <tr>
                                        <td>Overhead Cost</td>
                                        <td class="text-end">
                                            <input type="number" class="form-control form-control-sm text-end" id="overheadCost" value="0">
                                        </td>
                                        <td class="text-end" id="overheadCostPerUnit">0.00</td>
                                    </tr>
                                    <tr class="table-primary">
                                        <th>Total Estimated Cost</th>
                                        <th class="text-end" id="totalCost">0.00</th>
                                        <th class="text-end" id="totalCostPerUnit">0.00</th>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 5: Additional Details -->
        <div class="card shadow-sm mb-4">
            <div class="card-header" style="background-color: #f8f9fa; color: #495057; border-left: 4px solid #6c757d;">
                <h5 class="mb-0">
                    <i class="fas fa-sticky-note me-2"></i>
                    Additional Details & Instructions
                </h5>
                <small>Special instructions, remarks, and additional configuration options</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Team Work Configuration -->
                    <div class="col-md-6 mb-3">
                        <div class="form-check form-switch">
                            {{ form.is_team_work(class="form-check-input", id="is_team_work") }}
                            <label class="form-check-label" for="is_team_work">
                                <strong>Team Work</strong>
                                <small class="text-muted d-block">Multiple workers/teams will work on this job</small>
                            </label>
                        </div>
                        
                        <div id="teamWorkConfig" style="display: none;" class="mt-2">
                            <label for="max_team_members" class="form-label">Maximum Team Members</label>
                            {{ form.max_team_members(class="form-control", id="max_team_members") }}
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="col-md-6 mb-3">
                        <label for="customer_name" class="form-label">Customer/Client Name</label>
                        {{ form.customer_name(class="form-control", id="customer_name", placeholder="Enter customer or client name") }}
                        <div class="form-text">Optional: Customer for whom this job work is being done</div>
                    </div>

                    <!-- Remarks and Instructions -->
                    <div class="col-12 mb-3">
                        <label for="remarks" class="form-label">Remarks & Special Instructions</label>
                        {{ form.remarks(class="form-control", id="remarks", rows="3", placeholder="Enter any special instructions, quality requirements, or important notes for this job work...") }}
                        <div class="form-text">Detailed instructions will be included in the job work document and gate pass</div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="col-12 mb-3">
                        <label for="notes" class="form-label">Internal Notes</label>
                        {{ form.notes(class="form-control", id="notes", rows="2", placeholder="Internal notes for planning and coordination (not visible to vendor)") }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="validateForm()">
                            <i class="fas fa-check-circle"></i> Validate Form
                        </button>
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="saveDraft()">
                            <i class="fas fa-save"></i> Save as Draft
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary me-2" onclick="resetForm()">
                            <i class="fas fa-undo"></i> Reset Form
                        </button>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="fas fa-paper-plane"></i> Create Job Work
                        </button>
                    </div>
                </div>
                
                <!-- Form Status -->
                <div id="formStatus" class="mt-3" style="display: none;">
                    <!-- Status messages will appear here -->
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Job Work Form Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle text-primary"></i> Basic Information</h6>
                        <ul class="small">
                            <li><strong>BOM-Based:</strong> Auto-loads materials from Bill of Materials with multi-level explosion</li>
                            <li><strong>Manual Entry:</strong> Manually select materials and quantities</li>
                            <li><strong>In-House:</strong> Work done by internal departments</li>
                            <li><strong>Outsourced:</strong> Work sent to external vendors</li>
                        </ul>
                        
                        <h6><i class="fas fa-box text-success"></i> Materials & Batches</h6>
                        <ul class="small">
                            <li><strong>Batch Tracking:</strong> FIFO-based material tracking</li>
                            <li><strong>Multi-State Inventory:</strong> Raw, WIP, Finished, Scrap states</li>
                            <li><strong>Phantom BOMs:</strong> Automatic sub-assembly explosion</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cogs text-warning"></i> Advanced Features</h6>
                        <ul class="small">
                            <li><strong>Multi-Vendor Routing:</strong> Sequential processing through multiple vendors</li>
                            <li><strong>3-Step GRN:</strong> Material Receipt → Invoice → Payment workflow</li>
                            <li><strong>Partial Jobs:</strong> Partial material issuance and receipt support</li>
                            <li><strong>Cost Integration:</strong> Automatic costing with scrap and overhead tracking</li>
                        </ul>
                        
                        <h6><i class="fas fa-dollar-sign text-info"></i> Costing & Integration</h6>
                        <ul class="small">
                            <li><strong>Production Integration:</strong> Links to production orders and planning</li>
                            <li><strong>Accounting Integration:</strong> Automatic journal entries and cost allocation</li>
                            <li><strong>Quality Control:</strong> Integrated quality tracking and validation</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
.form-check-card .card {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.form-check-card input:checked + label .card {
    border-color: #0d6efd;
    background-color: #f8f9ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.job-type-selector {
    display: flex;
    gap: 1rem;
}

.work-type-selector .form-check-inline {
    margin-right: 2rem;
}

.work-type-selector .form-check-label {
    font-weight: 500;
    cursor: pointer;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.work-type-selector input:checked + label {
    background-color: #e3f2fd;
    border-color: #2196f3;
    color: #1976d2;
}

.required::after {
    content: " *";
    color: #dc3545;
}

.card-header small {
    opacity: 0.9;
}

#formStatus {
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.table th, .table td {
    vertical-align: middle;
}
</style>

<script>
// Form functionality
document.addEventListener('DOMContentLoaded', function() {
    // Job work type toggle
    const bomRadio = document.getElementById('type_bom');
    const manualRadio = document.getElementById('type_manual');
    const bomSelection = document.getElementById('bomSelection');
    const bomMaterialsSection = document.getElementById('bomMaterialsSection');
    const manualMaterialsSection = document.getElementById('manualMaterialsSection');

    function toggleJobWorkType() {
        if (bomRadio.checked) {
            bomSelection.style.display = 'block';
            bomMaterialsSection.style.display = 'block';
            manualMaterialsSection.style.display = 'none';
        } else {
            bomSelection.style.display = 'none';
            bomMaterialsSection.style.display = 'none';
            manualMaterialsSection.style.display = 'block';
        }
    }

    bomRadio.addEventListener('change', toggleJobWorkType);
    manualRadio.addEventListener('change', toggleJobWorkType);

    // Work type toggle with assignment filtering
    const inHouseRadio = document.getElementById('work_in_house');
    const outsourcedRadio = document.getElementById('work_outsourced');
    const assignedToSelect = document.getElementById('assigned_to');
    
    // Store all original options when page loads
    let allAssignedToOptions = [];
    
    // Store original options on page load
    function storeOriginalOptions() {
        const options = assignedToSelect.querySelectorAll('option');
        allAssignedToOptions = Array.from(options).map(option => ({
            value: option.value,
            text: option.text,
            isDepartment: option.value.startsWith('dept_'),
            isVendor: option.value.startsWith('supplier_')
        }));
    }
    
    function filterAssignedToOptions(showDepartments, showVendors) {
        // Clear current options
        assignedToSelect.innerHTML = '';
        
        // Add filtered options back
        allAssignedToOptions.forEach(option => {
            if (option.value === '' || // Always include empty/default option
                (showDepartments && option.isDepartment) ||
                (showVendors && option.isVendor)) {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.text = option.text;
                assignedToSelect.appendChild(optionElement);
            }
        });
        
        // Reset selection to default
        assignedToSelect.value = '';
    }

    function toggleWorkType() {
        const helpText = document.getElementById('assignmentHelpText');
        
        if (inHouseRadio.checked) {
            // Show only departments for in-house work
            filterAssignedToOptions(true, false);
            helpText.textContent = 'Select internal department for in-house work execution.';
        } else {
            // Show only vendors for outsourced work
            filterAssignedToOptions(false, true);
            helpText.textContent = 'Select vendor for outsourced work. Supports multi-vendor sequential routing.';
        }
    }

    // Store original options when page loads
    storeOriginalOptions();
    
    // Add event listeners
    inHouseRadio.addEventListener('change', toggleWorkType);
    outsourcedRadio.addEventListener('change', toggleWorkType);
    
    // Initialize filtering based on current selection
    toggleWorkType();

    // Team work toggle
    const teamWorkCheckbox = document.getElementById('is_team_work');
    const teamWorkConfig = document.getElementById('teamWorkConfig');

    teamWorkCheckbox.addEventListener('change', function() {
        teamWorkConfig.style.display = this.checked ? 'block' : 'none';
    });

    // Multi-vendor routing toggle
    const multiVendorCheckbox = document.getElementById('enableMultiVendor');
    const multiVendorRouting = document.getElementById('multiVendorRouting');

    multiVendorCheckbox.addEventListener('change', function() {
        multiVendorRouting.style.display = this.checked ? 'block' : 'none';
    });

    // Auto-generate title
    document.getElementById('autoGenerateTitle').addEventListener('click', function() {
        const jobType = document.querySelector('input[name="job_work_type"]:checked')?.value || 'manual';
        const workType = document.querySelector('input[name="work_type"]:checked')?.value || 'outsourced';
        const material = document.getElementById('input_material_id').selectedOptions[0]?.text || 'Material';
        
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const title = `JW-${timestamp}-${material.split(' ')[0]}-${workType.charAt(0).toUpperCase()}`;
        
        document.getElementById('job_title').value = title;
    });

    // Cost calculations based on BOM process rates
    function updateCostCalculations() {
        const quantity = parseFloat(document.getElementById('quantity_to_issue').value) || 0;
        const transportCost = parseFloat(document.getElementById('transportationCost').value) || 0;
        const overheadCost = parseFloat(document.getElementById('overheadCost').value) || 0;

        // Calculate process cost from BOM rates (this will be populated when BOM processes are selected)
        let processCost = 0;
        const processRateInputs = document.querySelectorAll('#processRatesList input[data-process-rate]');
        processRateInputs.forEach(input => {
            const rate = parseFloat(input.value) || 0;
            processCost += rate * quantity;
        });
        
        const totalCost = processCost + transportCost + overheadCost;
        
        document.getElementById('processCost').textContent = processCost.toFixed(2);
        document.getElementById('processCostPerUnit').textContent = (quantity > 0 ? (processCost / quantity).toFixed(2) : '0.00');
        document.getElementById('transportationCostPerUnit').textContent = (quantity > 0 ? (transportCost / quantity).toFixed(2) : '0.00');
        document.getElementById('overheadCostPerUnit').textContent = (quantity > 0 ? (overheadCost / quantity).toFixed(2) : '0.00');
        document.getElementById('totalCost').textContent = totalCost.toFixed(2);
        document.getElementById('totalCostPerUnit').textContent = (quantity > 0 ? (totalCost / quantity).toFixed(2) : '0.00');
    }

    // Add event listeners for cost calculations
    ['quantity_to_issue', 'transportationCost', 'overheadCost'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateCostCalculations);
        }
    });
    
    // Add event listener for process rate changes (will be added dynamically when BOM processes load)
    document.addEventListener('input', function(e) {
        if (e.target.matches('#processRatesList input[data-process-rate]')) {
            updateCostCalculations();
        }
    });

    // Initialize calculations
    updateCostCalculations();
});

function validateForm() {
    const status = document.getElementById('formStatus');
    const requiredFields = ['job_title', 'assigned_to', 'quantity_to_issue'];
    let isValid = true;
    let messages = [];

    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            isValid = false;
            messages.push(`${field.previousElementSibling.textContent.replace(' *', '')} is required`);
        }
    });

    if (isValid) {
        status.className = 'mt-3 alert alert-success';
        status.innerHTML = '<i class="fas fa-check-circle"></i> Form validation passed! Ready to submit.';
        document.getElementById('submitBtn').disabled = false;
    } else {
        status.className = 'mt-3 alert alert-danger';
        status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please fix the following issues:<ul class="mb-0 mt-2">' + 
                          messages.map(msg => `<li>${msg}</li>`).join('') + '</ul>';
        document.getElementById('submitBtn').disabled = true;
    }

    status.style.display = 'block';
}

function saveDraft() {
    const status = document.getElementById('formStatus');
    status.className = 'mt-3 alert alert-info';
    status.innerHTML = '<i class="fas fa-save"></i> Draft saved successfully! You can continue editing later.';
    status.style.display = 'block';
}

function resetForm() {
    if (confirm('Are you sure you want to reset the entire form? All entered data will be lost.')) {
        document.getElementById('jobWorkForm').reset();
        document.getElementById('formStatus').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
    }
}

// BOM Auto-Population Functionality
function handleBOMSelection() {
    const bomSelect = document.getElementById('bom_id');
    const bomId = bomSelect.value;
    
    console.log('BOM Selection changed:', bomId); // DEBUG
    
    if (!bomId || bomId === '0') {
        console.log('No BOM selected, clearing fields'); // DEBUG
        // Clear auto-populated fields when no BOM is selected
        clearBOMFields();
        return;
    }
    
    // Show loading indicator
    showBOMLoadingState(true);
    
    const apiUrl = `{{ url_for('jobwork.get_bom_details', bom_id=0) }}`.replace('0', bomId);
    console.log('Fetching BOM details from:', apiUrl); // DEBUG
    
    // Fetch BOM details from API
    fetch(apiUrl)
        .then(response => {
            console.log('API Response status:', response.status); // DEBUG
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data); // DEBUG
            if (data.success) {
                console.log('Populating form with BOM data:', data.bom_data); // DEBUG
                populateFormFromBOM(data.bom_data);
                showBOMSuccessMessage(data.bom_data.bom_code);
            } else {
                console.error('API Error:', data.error); // DEBUG
                showBOMErrorMessage(data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching BOM details:', error);
            showBOMErrorMessage('Failed to fetch BOM details. Please try again.');
        })
        .finally(() => {
            showBOMLoadingState(false);
        });
}

function populateFormFromBOM(bomData) {
    console.log('Starting form population with BOM data:', bomData); // DEBUG
    
    // 1. Set output item (product that BOM produces)
    const outputItemSelect = document.getElementById('item_id');
    console.log('Output item select element:', outputItemSelect); // DEBUG
    if (outputItemSelect && bomData.product_id) {
        console.log('Setting output item to:', bomData.product_id); // DEBUG
        outputItemSelect.value = bomData.product_id;
        // Trigger change event to update dependent fields
        outputItemSelect.dispatchEvent(new Event('change'));
    }
    
    // 2. Set input material (first material from BOM items)
    const inputMaterialSelect = document.getElementById('input_material_id');
    console.log('Input material select element:', inputMaterialSelect); // DEBUG
    console.log('Available input materials:', bomData.input_materials); // DEBUG
    if (inputMaterialSelect && bomData.input_materials && bomData.input_materials.length > 0) {
        const firstMaterial = bomData.input_materials[0];
        console.log('Setting input material to:', firstMaterial.material_id); // DEBUG
        inputMaterialSelect.value = firstMaterial.material_id;
        // Trigger change event to update dependent fields
        inputMaterialSelect.dispatchEvent(new Event('change'));
        
        // Set suggested quantity
        const quantityField = document.getElementById('quantity_to_issue');
        console.log('Quantity field element:', quantityField); // DEBUG
        if (quantityField) {
            console.log('Setting quantity to:', firstMaterial.qty_required); // DEBUG
            quantityField.value = firstMaterial.qty_required;
        }
    } else {
        console.log('No input materials found or input material select not found'); // DEBUG
    }
    
    // 3. Set Expected Scrap % from BOM
    const scrapField = document.getElementById('expected_scrap');
    console.log('Scrap field element:', scrapField); // DEBUG
    if (scrapField && bomData.estimated_scrap_percent !== undefined) {
        console.log('Setting scrap percentage to:', bomData.estimated_scrap_percent); // DEBUG
        scrapField.value = bomData.estimated_scrap_percent;
    }
    
    // 4. Populate process selection checkboxes
    populateBOMProcessSelection(bomData.processes, bomData.bom_code);
    
    // 5. Set job title with BOM code
    const jobTitleField = document.getElementById('job_title');
    if (jobTitleField && !jobTitleField.value) {
        const newTitle = `${bomData.bom_code} - Multi-Process Job`;
        console.log('Setting job title to:', newTitle); // DEBUG
        jobTitleField.value = newTitle;
    }
    
    // 4. Show BOM details summary
    showBOMDetailsSummary(bomData);
}

function populateBOMProcessSelection(processes, bomCode) {
    const processSelectionDiv = document.getElementById('bomProcessSelection');
    const processListDiv = document.getElementById('bomProcessList');
    
    if (!processSelectionDiv || !processListDiv) {
        console.log('Process selection divs not found'); // DEBUG
        return;
    }
    
    console.log('Populating process selection with processes:', processes); // DEBUG
    
    if (!processes || processes.length === 0) {
        processSelectionDiv.style.display = 'none';
        return;
    }
    
    // Store processes globally for rate calculation
    window.bomProcesses = processes;
    
    // Clear existing process list
    processListDiv.innerHTML = '';
    
    // Create checkboxes for each process
    processes.forEach((process, index) => {
        const processDiv = document.createElement('div');
        processDiv.className = 'form-check mb-3 p-3 border rounded';
        
        const checkboxId = `process_${process.step_number || index}`;
        
        processDiv.innerHTML = `
            <input class="form-check-input" type="checkbox" value="${process.step_number || index}" id="${checkboxId}" name="bom_processes" ${index === 0 ? 'checked' : ''}>
            <label class="form-check-label" for="${checkboxId}">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>Step ${process.step_number || (index + 1)}: ${process.process_name || 'Unnamed Process'}</strong>
                        ${process.process_code ? `<span class="badge bg-secondary ms-2">${process.process_code}</span>` : ''}
                        <br>
                        <small class="text-muted">${process.operation_description || 'No description available'}</small>
                    </div>
                    <div class="text-end">
                        ${process.setup_time_minutes ? `<small class="text-info d-block">Setup: ${process.setup_time_minutes} min</small>` : ''}
                        ${process.run_time_minutes ? `<small class="text-info d-block">Runtime: ${process.run_time_minutes} min/unit</small>` : ''}
                        ${process.cost_per_unit ? `<small class="text-success d-block">Cost: ₹${process.cost_per_unit}/unit</small>` : ''}
                    </div>
                </div>
            </label>
        `;
        
        processListDiv.appendChild(processDiv);
    });
    
    // Show the process selection section
    processSelectionDiv.style.display = 'block';
    
    // Add event listeners to update hidden field when checkboxes change
    updateSelectedProcesses();
    const checkboxes = processListDiv.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedProcesses();
            updateProcessRates();
        });
    });
    
    // Initial population of process rates
    updateProcessRates();
}

function updateSelectedProcesses() {
    const checkboxes = document.querySelectorAll('input[name="bom_processes"]:checked');
    const selectedValues = Array.from(checkboxes).map(cb => cb.value);
    const hiddenField = document.getElementById('selectedProcesses');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(selectedValues);
        console.log('Selected processes updated:', selectedValues); // DEBUG
    }
}

function updateProcessRates() {
    const processRatesSection = document.getElementById('processRatesSection');
    const processRatesList = document.getElementById('processRatesList');
    
    if (!processRatesSection || !processRatesList || !window.bomProcesses) {
        return;
    }
    
    // Get selected processes
    const checkboxes = document.querySelectorAll('input[name="bom_processes"]:checked');
    const selectedSteps = Array.from(checkboxes).map(cb => cb.value);
    
    if (selectedSteps.length === 0) {
        processRatesSection.style.display = 'none';
        return;
    }
    
    // Clear existing rates
    processRatesList.innerHTML = '';
    
    const ratesData = [];
    
    // Create rate fields for selected processes
    selectedSteps.forEach(stepNumber => {
        const process = window.bomProcesses.find(p => (p.step_number || window.bomProcesses.indexOf(p)) == stepNumber);
        if (process) {
            const rateDiv = document.createElement('div');
            rateDiv.className = 'row mb-3';
            
            const processRate = process.cost_per_unit || 0;
            
            rateDiv.innerHTML = `
                <div class="col-md-6">
                    <label class="form-label"><strong>${process.process_name}</strong> Rate per ${process.unit_of_measure || 'Unit'}</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="number" class="form-control" id="rate_step_${stepNumber}" 
                               value="${processRate}" step="0.01" min="0"
                               data-step="${stepNumber}" data-process="${process.process_name}" data-process-rate>
                        <span class="input-group-text">/${process.unit_of_measure || 'unit'}</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Estimated Cost</label>
                    <div class="form-control-plaintext bg-light rounded px-2" id="cost_step_${stepNumber}">
                        ${calculateProcessCost(process, processRate)}
                    </div>
                </div>
            `;
            
            processRatesList.appendChild(rateDiv);
            
            // Store rate data
            ratesData.push({
                step_number: stepNumber,
                process_name: process.process_name,
                rate_per_unit: processRate,
                setup_time_minutes: process.setup_time_minutes || 0,
                run_time_minutes: process.run_time_minutes || 0
            });
        }
    });
    
    // Store rates data in hidden field
    const hiddenRatesField = document.getElementById('processRatesData');
    if (hiddenRatesField) {
        hiddenRatesField.value = JSON.stringify(ratesData);
    }
    
    // Show rates section
    processRatesSection.style.display = 'block';
    
    // Add event listeners to rate inputs
    const rateInputs = processRatesList.querySelectorAll('input[type="number"]');
    rateInputs.forEach(input => {
        input.addEventListener('input', function() {
            const stepNumber = this.dataset.step;
            const process = window.bomProcesses.find(p => (p.step_number || window.bomProcesses.indexOf(p)) == stepNumber);
            const newRate = parseFloat(this.value) || 0;
            
            // Update cost display
            const costDisplay = document.getElementById(`cost_step_${stepNumber}`);
            if (costDisplay) {
                costDisplay.textContent = calculateProcessCost(process, newRate);
            }
            
            // Update hidden rates data
            updateRatesData();
        });
    });
}

function calculateProcessCost(process, ratePerUnit) {
    const quantity = parseFloat(document.getElementById('quantity_to_issue')?.value) || 1;
    const unit = process.unit_of_measure || 'unit';
    
    // For per-unit costs, simply multiply rate by quantity
    const totalCost = ratePerUnit * quantity;
    
    return `₹${totalCost.toFixed(2)} (₹${ratePerUnit.toFixed(2)} × ${quantity} ${unit}s)`;
}

function updateRatesData() {
    const rateInputs = document.querySelectorAll('#processRatesList input[type="number"]');
    const ratesData = [];
    
    rateInputs.forEach(input => {
        const stepNumber = input.dataset.step;
        const processName = input.dataset.process;
        const rate = parseFloat(input.value) || 0;
        const process = window.bomProcesses.find(p => (p.step_number || window.bomProcesses.indexOf(p)) == stepNumber);
        
        ratesData.push({
            step_number: stepNumber,
            process_name: processName,
            rate_per_unit: rate,
            setup_time_minutes: process?.setup_time_minutes || 0,
            run_time_minutes: process?.run_time_minutes || 0
        });
    });
    
    const hiddenRatesField = document.getElementById('processRatesData');
    if (hiddenRatesField) {
        hiddenRatesField.value = JSON.stringify(ratesData);
        console.log('Process rates data updated:', ratesData); // DEBUG
    }
}

function clearBOMFields() {
    // Clear the BOM info display
    const bomInfoDiv = document.getElementById('bomInfoDisplay');
    if (bomInfoDiv) {
        bomInfoDiv.style.display = 'none';
    }
    
    // Hide process selection
    const processSelectionDiv = document.getElementById('bomProcessSelection');
    if (processSelectionDiv) {
        processSelectionDiv.style.display = 'none';
    }
    
    // Hide process rates section
    const processRatesSection = document.getElementById('processRatesSection');
    if (processRatesSection) {
        processRatesSection.style.display = 'none';
    }
}

function showBOMLoadingState(isLoading) {
    const bomSelect = document.getElementById('bom_id');
    const loadingDiv = document.getElementById('bomLoadingIndicator');
    
    if (isLoading) {
        bomSelect.disabled = true;
        if (loadingDiv) {
            loadingDiv.style.display = 'block';
        } else {
            // Create loading indicator if it doesn't exist
            const loading = document.createElement('div');
            loading.id = 'bomLoadingIndicator';
            loading.className = 'alert alert-info mt-2';
            loading.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading BOM details...';
            bomSelect.parentNode.appendChild(loading);
        }
    } else {
        bomSelect.disabled = false;
        if (loadingDiv) {
            loadingDiv.style.display = 'none';
        }
    }
}

function showBOMSuccessMessage(bomCode) {
    const messageDiv = document.getElementById('bomMessage') || createBOMMessageDiv();
    messageDiv.className = 'alert alert-success mt-2';
    messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> BOM "${bomCode}" loaded successfully! Form fields have been auto-populated.`;
    messageDiv.style.display = 'block';
    
    // Hide message after 5 seconds
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

function showBOMErrorMessage(error) {
    const messageDiv = document.getElementById('bomMessage') || createBOMMessageDiv();
    messageDiv.className = 'alert alert-danger mt-2';
    messageDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error}`;
    messageDiv.style.display = 'block';
}

function createBOMMessageDiv() {
    const messageDiv = document.createElement('div');
    messageDiv.id = 'bomMessage';
    messageDiv.style.display = 'none';
    
    const bomSelect = document.getElementById('bom_id');
    bomSelect.parentNode.appendChild(messageDiv);
    
    return messageDiv;
}

function showBOMDetailsSummary(bomData) {
    let summaryHtml = `
        <div class="card mt-3" id="bomInfoDisplay">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-sitemap"></i> BOM Details: ${bomData.bom_code}</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Output:</strong> ${bomData.product_name} (${bomData.output_quantity} units)
                    </div>
                    <div class="col-md-6">
                        <strong>Input Materials:</strong> ${bomData.input_materials.length} items
                    </div>
                </div>`;
    
    if (bomData.input_materials.length > 0) {
        summaryHtml += `
                <div class="mt-2">
                    <strong>Primary Input:</strong> ${bomData.input_materials[0].material_name} 
                    (${bomData.input_materials[0].qty_required} ${bomData.input_materials[0].uom})
                </div>`;
    }
    
    if (bomData.processes.length > 0) {
        summaryHtml += `
                <div class="mt-2">
                    <strong>Primary Process:</strong> ${bomData.processes[0].process_name}
                </div>`;
    }
    
    summaryHtml += `
            </div>
        </div>`;
    
    // Remove existing BOM info display
    const existingDisplay = document.getElementById('bomInfoDisplay');
    if (existingDisplay) {
        existingDisplay.remove();
    }
    
    // Add new display after BOM select field
    const bomSelect = document.getElementById('bom_id');
    bomSelect.parentNode.insertAdjacentHTML('afterend', summaryHtml);
}

// Initialize BOM functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    const bomSelect = document.getElementById('bom_id');
    if (bomSelect) {
        bomSelect.addEventListener('change', handleBOMSelection);
        
        // If BOM is pre-selected, load its details
        if (bomSelect.value && bomSelect.value !== '0') {
            handleBOMSelection();
        }
    }
});
</script>

{% endblock %}