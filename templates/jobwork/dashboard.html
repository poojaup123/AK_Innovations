{% extends "base.html" %}

{% block title %}Job Work Dashboard - Factory Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-tools"></i> Job Work Dashboard</h1>
            <p class="text-muted">Track materials sent for job work and received back via GRN system</p>
        </div>
        <div class="col-auto">
            <div class="btn-group">
                <a href="{{ url_for('jobwork.add_job_work') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Job Work
                </a>
                <a href="{{ url_for('grn.dashboard') }}" class="btn btn-success">
                    <i class="fas fa-receipt"></i> GRN Dashboard
                </a>
                <a href="{{ url_for('live_status.process_dashboard') }}" class="btn btn-info">
                    <i class="fas fa-broadcast-tower"></i> Live Status
                </a>
                <a href="{{ url_for('live_status.wip_breakdown') }}" class="btn btn-warning">
                    <i class="fas fa-chart-pie"></i> WIP Breakdown
                </a>
            </div>
            <div class="alert alert-info mt-2 mb-0">
                <i class="fas fa-info-circle"></i> <strong>Unified Job Work Form:</strong> One form handles both regular and multi-process job works seamlessly
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2 mb-3">
            <div class="card bg-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Jobs</h5>
                            <h3>{{ stats.total_jobs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tools fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-2 mb-3">
            <div class="card bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Sent Jobs</h5>
                            <h3>{{ stats.sent_jobs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-arrow-right fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-2 mb-3">
            <div class="card bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Partial Received</h5>
                            <h3>{{ stats.partial_received }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-2 mb-3">
            <div class="card bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Completed Jobs</h5>
                            <h3>{{ stats.completed_jobs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-2 mb-3">
            <div class="card bg-secondary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">In-House Jobs</h5>
                            <h3>{{ stats.in_house_jobs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-2 mb-3">
            <div class="card bg-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Team Jobs</h5>
                            <h3>{{ stats.team_jobs }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified GRN Workflow Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info border-start border-info border-4" role="alert">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5><i class="fas fa-info-circle me-2"></i>Unified GRN-Based Job Work Workflow</h5>
                        <p class="mb-2">
                            <strong>All job works (In-House and Outsourced) now use the GRN system for material receipt.</strong>
                            This creates a unified workflow for receiving and inspecting returned materials.
                        </p>
                        <ul class="mb-0">
                            <li><strong>In-House Jobs:</strong> Use GRN to receive completed materials from internal departments</li>
                            <li><strong>Outsourced Jobs:</strong> Use GRN to receive materials from external vendors</li>
                            <li><strong>Multi-Process Jobs:</strong> Use GRN for each process completion stage</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('grn.dashboard') }}" class="btn btn-success">
                                <i class="fas fa-receipt me-1"></i>Access GRN Dashboard
                            </a>
                            <small class="text-muted text-center">
                                <i class="fas fa-robot me-1"></i>Daily entries replaced by GRN system
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Work Progress Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>
                        <i class="fas fa-chart-line"></i> Active Job Work Progress
                        <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#jobProgressSection" 
                                aria-expanded="true" aria-controls="jobProgressSection"
                                id="toggleProgressBtn">
                            <i class="fas fa-chevron-up" id="toggleProgressIcon"></i>
                        </button>
                    </h5>
                    <span class="badge bg-info">{{ active_jobs|length }} Active Jobs</span>
                </div>
                <div class="collapse show" id="jobProgressSection">
                    <div class="card-body p-0">
                        <div class="job-progress-scroll" style="max-height: 600px; overflow-y: auto; padding: 1rem;">
                    {% if active_jobs %}
                        {% for job in active_jobs %}
                        <div class="card mb-3 border-left-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'partial_received' else 'primary' }}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6 class="card-title mb-2">
                                            <a href="{{ url_for('jobwork.detail', id=job.id) }}" class="text-decoration-none">
                                                {{ job.job_number }} - {{ job.item.name }}
                                            </a>
                                            <span class="badge bg-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'partial_received' else 'primary' }} ms-2">
                                                {{ job.status.replace('_', ' ').title() }}
                                            </span>
                                            {% if job.work_type == 'in_house' %}
                                                <span class="badge bg-secondary ms-1">In-House</span>
                                            {% endif %}
                                            {% if job.is_team_work %}
                                                <span class="badge bg-info ms-1">Team Work</span>
                                            {% endif %}
                                        </h6>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fas fa-user"></i> {{ job.customer_name if job.work_type == 'outsourced' else job.department }}
                                                </small><br>
                                                <small class="text-muted">
                                                    <i class="fas fa-box"></i> {{ job.quantity_sent }} {{ job.item.unit_of_measure }} sent
                                                </small><br>
                                                <small class="text-success">
                                                    <i class="fas fa-check"></i> {{ job.quantity_received or 0 }} {{ job.item.unit_of_measure }} received
                                                </small><br>
                                                <small class="{% if job.pending_quantity > 0 %}text-warning{% else %}text-muted{% endif %}">
                                                    <i class="fas fa-clock"></i> {{ job.pending_receipt_display }} pending
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar"></i> {{ job.sent_date.strftime('%d %b %Y') if job.sent_date else 'N/A' }}
                                                </small><br>
                                                {% if job.expected_return %}
                                                <small class="text-muted">
                                                    <i class="fas fa-clock"></i> Expected: {{ job.expected_return.strftime('%d %b %Y') }}
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if job.is_team_work and job.id in team_assignments %}
                                        <div class="mt-3">
                                            <h6><i class="fas fa-users"></i> Team Progress:</h6>
                                            <div class="row">
                                                {% for assignment in team_assignments[job.id] %}
                                                <div class="col-md-6 mb-2">
                                                    <div class="card border-0 bg-light">
                                                        <div class="card-body p-2">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <div>
                                                                    <strong>{{ assignment.employee.name }}</strong><br>
                                                                    <small class="text-muted">{{ assignment.assigned_quantity }} {{ job.item.unit_of_measure }} assigned</small>
                                                                </div>
                                                                <div class="text-end">
                                                                    <span class="badge bg-{{ assignment.status_badge_class }}">
                                                                        {{ assignment.status.replace('_', ' ').title() }}
                                                                    </span>
                                                                    <div class="progress mt-1" style="height: 8px; width: 60px;">
                                                                        <div class="progress-bar {{ assignment.completion_progress_class }}" 
                                                                             style="width: {{ assignment.completion_percentage }}%">
                                                                        </div>
                                                                    </div>
                                                                    <small class="text-muted">{{ "%.0f"|format(assignment.completion_percentage) }}%</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-4 text-end">
                                        <div class="btn-group-vertical btn-group-sm">
                                            <a href="{{ url_for('jobwork.detail', id=job.id) }}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i> View Details
                                            </a>
                                            <a href="{{ url_for('jobwork.generate_challan', job_id=job.id) }}" class="btn btn-outline-info btn-sm" target="_blank">
                                                <i class="fas fa-file-invoice"></i> Challan
                                            </a>
                                            {% if job.is_team_work %}
                                            <a href="{{ url_for('jobwork.team_assignments', job_id=job.id) }}" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-users"></i> Team Assignments
                                            </a>
                                            {% endif %}
                                            {% if job.has_pending_quantity %}
                                            <a href="{{ url_for('grn.quick_receive', job_work_id=job.id) }}" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-receipt"></i> Receive Materials
                                            </a>
                                            {% else %}
                                            <span class="badge bg-success">Materials Received</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i> No active job works found. All jobs are completed!
                        </div>
                    {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('jobwork.list_job_works') }}" class="btn btn-outline-primary btn-sm w-100">
                                <i class="fas fa-list"></i> View All Jobs
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('jobwork.list_job_works', status='sent') }}" class="btn btn-outline-warning btn-sm w-100">
                                <i class="fas fa-clock"></i> Pending Returns
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('jobwork.worker_productivity') }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-chart-bar"></i> Worker Productivity
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('purchase.list_suppliers') }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-truck"></i> Job Work Vendors
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('jobwork_rates.dashboard') }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-money-bill-wave"></i> Job Work Rates
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('reports.jobwork_report') }}" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fas fa-chart-bar"></i> Job Work Report
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('grn.dashboard') }}" class="btn btn-outline-success btn-sm w-100">
                                <i class="fas fa-receipt"></i> GRN Dashboard
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('material_inspection.dashboard') }}" class="btn btn-outline-info btn-sm w-100">
                                <i class="fas fa-clipboard-check"></i> Material Inspection
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Job Works and Pending Returns -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Recent Job Works</h5>
                </div>
                <div class="card-body">
                    {% if recent_jobs %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Job Number</th>
                                        <th>Vendor</th>
                                        <th>Status</th>
                                        <th>Job Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in recent_jobs %}
                                    <tr>
                                        <td>{{ job.job_number }}</td>
                                        <td>{{ job.customer_name }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'partial_received' else 'primary' }}">
                                                {{ job.status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>{{ job.sent_date.strftime('%m/%d/%Y') if job.sent_date else 'N/A' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">No job works found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-exclamation-triangle"></i> Pending Returns</h5>
                </div>
                <div class="card-body">
                    {% if pending_jobs %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Job Number</th>
                                        <th>Vendor</th>
                                        <th>Expected Return</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for job in pending_jobs %}
                                    <tr>
                                        <td>{{ job.job_number }}</td>
                                        <td>{{ job.customer_name }}</td>
                                        <td>{{ job.expected_return.strftime('%m/%d/%Y') if job.expected_return else '-' }}</td>
                                        <td>
                                            {% if job.work_type in ['outsourced', 'multi_process', 'unified'] and job.has_pending_quantity %}
                                            <a href="{{ url_for('grn.quick_receive', job_work_id=job.id) }}" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-truck"></i> Receive Materials
                                            </a>
                                            {% elif job.work_type == 'in_house' and job.status != 'completed' %}
                                            <a href="{{ url_for('jobwork.daily_job_work_entry') }}" class="btn btn-outline-info btn-sm">
                                                <i class="fas fa-clock"></i> Daily Entry
                                            </a>
                                            {% elif job.work_type in ['outsourced', 'multi_process', 'unified'] and not job.has_pending_quantity %}
                                            <span class="badge bg-success">Materials Received</span>
                                            {% else %}
                                            <span class="badge bg-success">Completed</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> All job works are completed!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Top Vendors -->
    {% if top_vendors %}
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-trophy"></i> Top Job Work Vendors</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for vendor_name, job_count in top_vendors %}
                        <div class="col-md-3 mb-2">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>{{ vendor_name }}</h6>
                                    <h4>{{ job_count }}</h4>
                                    <small class="text-muted">jobs</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.job-progress-scroll {
    /* Custom scrollbar for webkit browsers */
    scrollbar-width: thin;
    scrollbar-color: #6c757d #f8f9fa;
}

.job-progress-scroll::-webkit-scrollbar {
    width: 8px;
}

.job-progress-scroll::-webkit-scrollbar-track {
    background: #f8f9fa;
    border-radius: 4px;
}

.job-progress-scroll::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 4px;
}

.job-progress-scroll::-webkit-scrollbar-thumb:hover {
    background: #495057;
}
</style>

<script>
// Handle collapse icon rotation for Job Work Progress section
document.addEventListener('DOMContentLoaded', function() {
    const progressSection = document.getElementById('jobProgressSection');
    const toggleIcon = document.getElementById('toggleProgressIcon');
    
    if (progressSection && toggleIcon) {
        progressSection.addEventListener('show.bs.collapse', function() {
            toggleIcon.className = 'fas fa-chevron-up';
        });
        
        progressSection.addEventListener('hide.bs.collapse', function() {
            toggleIcon.className = 'fas fa-chevron-down';
        });
    }
});
</script>
{% endblock %}
